{"version":3,"sources":["../../src/auth/auth.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\nimport { PrismaService } from '../prisma/prisma.service';\nimport * as bcrypt from 'bcrypt';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private usersService: UsersService,\n    private jwtService: JwtService,\n    private prisma: PrismaService,\n  ) {}\n\n  async validateUser(email: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(email);\n    if (user && (await bcrypt.compare(pass, user.password))) {\n      const result = { ...user };\n      delete (result as any).password;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user: any) {\n    const u = user as {\n      id: string;\n      email: string;\n      name: string;\n      role: any;\n      profileSlug?: string;\n      profileSettings?: any;\n      profileImage?: string;\n      parentOf?: any[];\n      parentRequests?: any[];\n    };\n    \n    const payload = { \n      email: u.email, \n      sub: u.id, \n      role: u.role \n    };\n\n    // Create login history\n    await this.prisma.loginHistory.create({\n      data: {\n        userId: u.id,\n      },\n    });\n\n    return {\n      access_token: this.jwtService.sign(payload),\n      user: {\n        id: u.id,\n        email: u.email,\n        name: u.name,\n        role: u.role,\n        profileSlug: u.profileSlug,\n        profileSettings: u.profileSettings,\n        profileImage: u.profileImage,\n        parentOf: u.parentOf,\n        parentRequests: u.parentRequests,\n      },\n    };\n  }\n\n  async logout(userId: string) {\n    const lastLogin = await this.prisma.loginHistory.findFirst({\n      where: { userId, logoutTime: null },\n      orderBy: { loginTime: 'desc' },\n    });\n\n    if (lastLogin) {\n      await this.prisma.loginHistory.update({\n        where: { id: lastLogin.id },\n        data: { logoutTime: new Date() },\n      });\n    }\n    return { message: 'Logged out successfully' };\n  }\n\n  async register(registerDto: any) {\n    const hashedPassword = await bcrypt.hash(registerDto.password, 10);\n    const user = await this.usersService.create({\n      ...registerDto,\n      password: hashedPassword,\n    });\n    return this.login(user);\n  }\n}\n"],"names":["AuthService","validateUser","email","pass","user","usersService","findOne","bcrypt","compare","password","result","login","u","payload","sub","id","role","prisma","loginHistory","create","data","userId","access_token","jwtService","sign","name","profileSlug","profileSettings","profileImage","parentOf","parentRequests","logout","lastLogin","findFirst","where","logoutTime","orderBy","loginTime","update","Date","message","register","registerDto","hashedPassword","hash"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPc;8BACE;qBACF;+BACG;gEACN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,cAAN,MAAMA;IAOX,MAAMC,aAAaC,KAAa,EAAEC,IAAY,EAAgB;QAC5D,MAAMC,OAAO,MAAM,IAAI,CAACC,YAAY,CAACC,OAAO,CAACJ;QAC7C,IAAIE,QAAS,MAAMG,QAAOC,OAAO,CAACL,MAAMC,KAAKK,QAAQ,GAAI;YACvD,MAAMC,SAAS;gBAAE,GAAGN,IAAI;YAAC;YACzB,OAAO,AAACM,OAAeD,QAAQ;YAC/B,OAAOC;QACT;QACA,OAAO;IACT;IAEA,MAAMC,MAAMP,IAAS,EAAE;QACrB,MAAMQ,IAAIR;QAYV,MAAMS,UAAU;YACdX,OAAOU,EAAEV,KAAK;YACdY,KAAKF,EAAEG,EAAE;YACTC,MAAMJ,EAAEI,IAAI;QACd;QAEA,uBAAuB;QACvB,MAAM,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,MAAM,CAAC;YACpCC,MAAM;gBACJC,QAAQT,EAAEG,EAAE;YACd;QACF;QAEA,OAAO;YACLO,cAAc,IAAI,CAACC,UAAU,CAACC,IAAI,CAACX;YACnCT,MAAM;gBACJW,IAAIH,EAAEG,EAAE;gBACRb,OAAOU,EAAEV,KAAK;gBACduB,MAAMb,EAAEa,IAAI;gBACZT,MAAMJ,EAAEI,IAAI;gBACZU,aAAad,EAAEc,WAAW;gBAC1BC,iBAAiBf,EAAEe,eAAe;gBAClCC,cAAchB,EAAEgB,YAAY;gBAC5BC,UAAUjB,EAAEiB,QAAQ;gBACpBC,gBAAgBlB,EAAEkB,cAAc;YAClC;QACF;IACF;IAEA,MAAMC,OAAOV,MAAc,EAAE;QAC3B,MAAMW,YAAY,MAAM,IAAI,CAACf,MAAM,CAACC,YAAY,CAACe,SAAS,CAAC;YACzDC,OAAO;gBAAEb;gBAAQc,YAAY;YAAK;YAClCC,SAAS;gBAAEC,WAAW;YAAO;QAC/B;QAEA,IAAIL,WAAW;YACb,MAAM,IAAI,CAACf,MAAM,CAACC,YAAY,CAACoB,MAAM,CAAC;gBACpCJ,OAAO;oBAAEnB,IAAIiB,UAAUjB,EAAE;gBAAC;gBAC1BK,MAAM;oBAAEe,YAAY,IAAII;gBAAO;YACjC;QACF;QACA,OAAO;YAAEC,SAAS;QAA0B;IAC9C;IAEA,MAAMC,SAASC,WAAgB,EAAE;QAC/B,MAAMC,iBAAiB,MAAMpC,QAAOqC,IAAI,CAACF,YAAYjC,QAAQ,EAAE;QAC/D,MAAML,OAAO,MAAM,IAAI,CAACC,YAAY,CAACc,MAAM,CAAC;YAC1C,GAAGuB,WAAW;YACdjC,UAAUkC;QACZ;QACA,OAAO,IAAI,CAAChC,KAAK,CAACP;IACpB;IAhFA,YACE,AAAQC,YAA0B,EAClC,AAAQkB,UAAsB,EAC9B,AAAQN,MAAqB,CAC7B;aAHQZ,eAAAA;aACAkB,aAAAA;aACAN,SAAAA;IACP;AA6EL"}