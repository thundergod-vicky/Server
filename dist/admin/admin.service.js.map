{"version":3,"sources":["../../src/admin/admin.service.ts"],"sourcesContent":["import { Injectable, ForbiddenException } from '@nestjs/common';\nimport { PrismaService } from '../prisma/prisma.service';\n\n@Injectable()\nexport class AdminService {\n  constructor(private prisma: PrismaService) {}\n\n  async getGlobalStats() {\n    const [\n      totalUsers,\n      totalStudents,\n      totalTeachers,\n      totalCourses,\n      totalRevenue,\n    ] = await Promise.all([\n      this.prisma.user.count(),\n      this.prisma.user.count({ where: { role: 'STUDENT' } }),\n      this.prisma.user.count({ where: { role: 'TEACHER' } }),\n      this.prisma.course.count(),\n      this.prisma.payment.aggregate({\n        where: { status: 'SUCCESS' },\n        _sum: { amount: true },\n      }),\n    ]);\n\n    return {\n      users: {\n        total: totalUsers,\n        students: totalStudents,\n        teachers: totalTeachers,\n      },\n      courses: {\n        total: totalCourses,\n      },\n      revenue: {\n        total: totalRevenue._sum.amount || 0,\n      },\n      systemStatus: 'Stable',\n      uptime: '99.9%',\n    };\n  }\n\n  async getAllUsers() {\n    return this.prisma.user.findMany({\n      include: {\n        _count: {\n          select: {\n            enrollments: true,\n            practiceTestResults: true,\n            coursesOwned: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async updateUserRole(userId: string, role: any) {\n    return this.prisma.user.update({\n      where: { id: userId },\n      data: { role },\n    });\n  }\n\n  async getAllCourses() {\n    return this.prisma.course.findMany({\n      include: {\n        teacher: { select: { name: true, email: true } },\n        _count: { select: { enrollments: true, chapters: true } },\n      },\n    });\n  }\n\n  async deleteCourse(courseId: string) {\n    return this.prisma.course.delete({\n      where: { id: courseId },\n    });\n  }\n\n  // Practice Test Management\n  async getAllPracticeTests() {\n    return this.prisma.practiceTest.findMany({\n      include: {\n        teacher: { select: { id: true, name: true, email: true } },\n        _count: { select: { results: true } },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async getTestAnalytics(testId: string) {\n    const test = await this.prisma.practiceTest.findUnique({\n      where: { id: testId },\n      include: {\n        teacher: { select: { id: true, name: true, email: true } },\n        results: {\n          include: {\n            student: { select: { id: true, name: true, email: true } },\n          },\n        },\n      },\n    });\n\n    if (!test) {\n      return null;\n    }\n\n    // Calculate analytics\n    const totalAttempts = test.results.length;\n    const completedAttempts = test.results.filter(\n      (r) => r.status === 'COMPLETED',\n    ).length;\n    const cheatedAttempts = test.results.filter(\n      (r) => r.status === 'CHEATED',\n    ).length;\n    const averageScore =\n      totalAttempts > 0\n        ? test.results.reduce((sum, r) => sum + r.score, 0) / totalAttempts\n        : 0;\n    const averagePercentage =\n      totalAttempts > 0\n        ? test.results.reduce((sum, r) => sum + (r.score / r.total) * 100, 0) /\n          totalAttempts\n        : 0;\n    const averageRating =\n      totalAttempts > 0\n        ? test.results.reduce((sum, r) => sum + (r.rating || 0), 0) /\n          totalAttempts\n        : 0;\n    const passRate =\n      totalAttempts > 0\n        ? (test.results.filter((r) => r.score / r.total >= 0.6).length /\n            totalAttempts) *\n          100\n        : 0;\n\n    // Calculate average time taken (only for completed tests)\n    const completedResults = test.results.filter(\n      (r) => r.status === 'COMPLETED' && r.timeTaken,\n    );\n    const averageTimeTaken =\n      completedResults.length > 0\n        ? completedResults.reduce((sum, r) => sum + (r.timeTaken || 0), 0) /\n          completedResults.length\n        : 0;\n\n    // Get unique students who attempted\n    const uniqueStudents = new Set(test.results.map((r) => r.studentId)).size;\n\n    return {\n      test,\n      analytics: {\n        totalAttempts,\n        uniqueStudents,\n        completedAttempts,\n        cheatedAttempts,\n        averageScore: parseFloat(averageScore.toFixed(2)),\n        averagePercentage: parseFloat(averagePercentage.toFixed(2)),\n        averageRating: parseFloat(averageRating.toFixed(2)),\n        passRate: parseFloat(passRate.toFixed(2)),\n        averageTimeTaken: Math.round(averageTimeTaken),\n        cheatingRate:\n          totalAttempts > 0\n            ? parseFloat(((cheatedAttempts / totalAttempts) * 100).toFixed(2))\n            : 0,\n      },\n    };\n  }\n\n  async getTestResults(testId: string) {\n    return this.prisma.practiceTestResult.findMany({\n      where: { testId },\n      include: {\n        student: { select: { id: true, name: true, email: true } },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async deletePracticeTest(testId: string) {\n    // First delete all results\n    await this.prisma.practiceTestResult.deleteMany({\n      where: { testId },\n    });\n\n    // Then delete the test\n    return this.prisma.practiceTest.delete({\n      where: { id: testId },\n    });\n  }\n}\n"],"names":["AdminService","getGlobalStats","totalUsers","totalStudents","totalTeachers","totalCourses","totalRevenue","Promise","all","prisma","user","count","where","role","course","payment","aggregate","status","_sum","amount","users","total","students","teachers","courses","revenue","systemStatus","uptime","getAllUsers","findMany","include","_count","select","enrollments","practiceTestResults","coursesOwned","orderBy","createdAt","updateUserRole","userId","update","id","data","getAllCourses","teacher","name","email","chapters","deleteCourse","courseId","delete","getAllPracticeTests","practiceTest","results","getTestAnalytics","testId","test","findUnique","student","totalAttempts","length","completedAttempts","filter","r","cheatedAttempts","averageScore","reduce","sum","score","averagePercentage","averageRating","rating","passRate","completedResults","timeTaken","averageTimeTaken","uniqueStudents","Set","map","studentId","size","analytics","parseFloat","toFixed","Math","round","cheatingRate","getTestResults","practiceTestResult","deletePracticeTest","deleteMany"],"mappings":"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"}