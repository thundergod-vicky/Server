{"version":3,"sources":["../../src/chat/chat.gateway.ts"],"sourcesContent":["import {\n  WebSocketGateway,\n  WebSocketServer,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n  SubscribeMessage,\n  MessageBody,\n  ConnectedSocket,\n} from '@nestjs/websockets';\nimport { Server, Socket } from 'socket.io';\nimport { JwtService } from '@nestjs/jwt';\nimport { ChatService } from './chat.service';\nimport { MessageType } from '@prisma/client';\n\n@WebSocketGateway({\n  cors: {\n    origin: ['http://localhost:3000', 'http://localhost:3001'],\n    credentials: true,\n  },\n})\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\n  @WebSocketServer()\n  server: Server;\n\n  constructor(\n    private jwtService: JwtService,\n    private chatService: ChatService,\n  ) {}\n\n  async handleConnection(client: Socket) {\n    try {\n      const token = client.handshake.auth.token || client.handshake.headers.authorization?.split(' ')[1];\n      if (!token) {\n        client.disconnect();\n        return;\n      }\n\n      const payload = this.jwtService.verify(token);\n      client.data.user = payload;\n      \n      // Join a room specific to this user\n      await client.join(`user_${payload.sub}`);\n      console.log(`User connected: ${payload.sub} (socket: ${client.id})`);\n    } catch (e) {\n      console.error('Socket connection error:', e.message);\n      client.disconnect();\n    }\n  }\n\n  handleDisconnect(client: Socket) {\n    if (client.data.user) {\n      console.log(`User disconnected: ${client.data.user.sub}`);\n    }\n  }\n\n  @SubscribeMessage('sendMessage')\n  async handleMessage(\n    @ConnectedSocket() client: Socket,\n    @MessageBody() data: { receiverId: string; message?: string; mediaUrl?: string; type: MessageType },\n  ) {\n    const senderId = client.data.user.sub;\n    try {\n      const message = await this.chatService.createMessage({\n        senderId,\n        ...data,\n      });\n\n      // Emit to receiver's room\n      this.server.to(`user_${data.receiverId}`).emit('newMessage', message);\n      \n      // Emit back to sender (for multi-device sync or acknowledgment)\n      this.server.to(`user_${senderId}`).emit('messageSent', message);\n      \n      return { success: true, message };\n    } catch (error) {\n      return { success: false, error: error.message };\n    }\n  }\n\n  @SubscribeMessage('sendRequest')\n  async handleRequest(\n    @ConnectedSocket() client: Socket,\n    @MessageBody() data: { receiverId: string; firstMessage: string },\n  ) {\n    const senderId = client.data.user.sub;\n    try {\n      const request = await this.chatService.sendChatRequest(\n        senderId,\n        data.receiverId,\n        data.firstMessage,\n      );\n\n      // Notify the teacher/admin\n      this.server.to(`user_${data.receiverId}`).emit('newChatRequest', request);\n      \n      return { success: true, request };\n    } catch (error) {\n      return { success: false, error: error.message };\n    }\n  }\n\n  @SubscribeMessage('typing')\n  handleTyping(\n    @ConnectedSocket() client: Socket,\n    @MessageBody() data: { receiverId: string; isTyping: boolean },\n  ) {\n    const senderId = client.data.user.sub;\n    this.server.to(`user_${data.receiverId}`).emit('userTyping', {\n      senderId,\n      isTyping: data.isTyping,\n    });\n  }\n}\n"],"names":["ChatGateway","handleConnection","client","token","handshake","auth","headers","authorization","split","disconnect","payload","jwtService","verify","data","user","join","sub","console","log","id","e","error","message","handleDisconnect","handleMessage","senderId","chatService","createMessage","server","to","receiverId","emit","success","handleRequest","request","sendChatRequest","firstMessage","handleTyping","isTyping","cors","origin","credentials"],"mappings":"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"}