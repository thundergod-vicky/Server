{"version":3,"sources":["../../src/chat/chat.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { MessageType, RequestStatus } from '@prisma/client';\nimport { NotificationsService } from '../notifications/notifications.service';\n\n@Injectable()\nexport class ChatService {\n  constructor(\n    private prisma: PrismaService,\n    private notificationsService: NotificationsService,\n  ) {}\n\n  async createMessage(data: {\n    senderId: string;\n    receiverId: string;\n    message?: string;\n    mediaUrl?: string;\n    type: MessageType;\n  }) {\n    // Check if there is an approved request or if sender is teacher\n    const sender = await this.prisma.user.findUnique({\n      where: { id: data.senderId },\n      select: { role: true },\n    });\n\n    if (sender?.role !== 'TEACHER' && sender?.role !== 'ADMIN') {\n      const request = await this.prisma.chatRequest.findUnique({\n        where: {\n          senderId_receiverId: {\n            senderId: data.senderId,\n            receiverId: data.receiverId,\n          },\n        },\n      });\n\n      if (!request || request.status !== 'APPROVED') {\n        throw new Error('Message request not approved yet');\n      }\n    }\n\n    const message = await this.prisma.chatMessage.create({\n      data: {\n        senderId: data.senderId,\n        receiverId: data.receiverId,\n        message: data.message,\n        mediaUrl: data.mediaUrl,\n        type: data.type,\n      },\n    });\n\n    // Create notification for receiver\n    await this.notificationsService.create(\n      data.receiverId,\n      'New Message',\n      `You received a new message from ${sender?.role === 'TEACHER' ? 'Teacher' : 'Student'}`,\n      'INFO',\n    );\n\n    return message;\n  }\n\n  async sendChatRequest(senderId: string, receiverId: string, firstMessage: string) {\n    // Check if recipient is a teacher\n    const receiver = await this.prisma.user.findUnique({\n      where: { id: receiverId },\n      select: { role: true },\n    });\n\n    if (receiver?.role !== 'TEACHER' && receiver?.role !== 'ADMIN') {\n      throw new Error('You can only send message requests to Teachers or Admins');\n    }\n\n    const request = await this.prisma.chatRequest.create({\n      data: {\n        senderId,\n        receiverId,\n        firstMessage,\n        status: 'PENDING',\n      },\n    });\n\n    await this.notificationsService.create(\n      receiverId,\n      'New Message Request',\n      'A student/parent wants to message you.',\n      'INFO',\n    );\n\n    return request;\n  }\n\n  async handleRequest(requestId: string, status: 'APPROVED' | 'REJECTED') {\n    const request = await this.prisma.chatRequest.update({\n      where: { id: requestId },\n      data: { status: status as RequestStatus },\n    });\n\n    if (status === 'APPROVED') {\n      // Create initial message from the request's firstMessage\n      await this.prisma.chatMessage.create({\n        data: {\n          senderId: request.senderId,\n          receiverId: request.receiverId,\n          message: request.firstMessage,\n          type: 'TEXT',\n        },\n      });\n    }\n\n    await this.notificationsService.create(\n      request.senderId,\n      'Message Request Update',\n      `Your message request has been ${status.toLowerCase()}.`,\n      status === 'APPROVED' ? 'INFO' : 'WARNING',\n    );\n\n    return request;\n  }\n\n  async getMessages(userId: string, contactId: string) {\n    return this.prisma.chatMessage.findMany({\n      where: {\n        OR: [\n          { senderId: userId, receiverId: contactId },\n          { senderId: contactId, receiverId: userId },\n        ],\n      },\n      orderBy: { timestamp: 'asc' },\n    });\n  }\n\n  async getChatList(userId: string) {\n    // Get all users the current user has exchanged messages with\n    const sent = await this.prisma.chatMessage.findMany({\n      where: { senderId: userId },\n      select: { receiverId: true },\n      distinct: ['receiverId'],\n    });\n\n    const received = await this.prisma.chatMessage.findMany({\n      where: { receiverId: userId },\n      select: { senderId: true },\n      distinct: ['senderId'],\n    });\n\n    const contactIds = [\n      ...new Set([\n        ...sent.map((s) => s.receiverId),\n        ...received.map((r) => r.senderId),\n      ]),\n    ].filter(Boolean) as string[];\n\n    return this.prisma.user.findMany({\n      where: { id: { in: contactIds } },\n      select: {\n        id: true,\n        name: true,\n        email: true,\n        role: true,\n        parentOf: {\n          include: {\n            student: { select: { name: true } }\n          }\n        }\n      },\n    });\n  }\n\n  async getPendingRequests(teacherId: string) {\n    return this.prisma.chatRequest.findMany({\n      where: { receiverId: teacherId, status: 'PENDING' },\n      include: {\n        sender: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n            role: true,\n            parentOf: {\n              include: {\n                student: { select: { name: true } }\n              }\n            }\n          }\n        }\n      }\n    });\n  }\n\n  async getSentRequests(senderId: string) {\n    return this.prisma.chatRequest.findMany({\n      where: { senderId, status: 'PENDING' },\n      include: {\n        receiver: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n            role: true,\n          }\n        }\n      }\n    });\n  }\n}\n"],"names":["ChatService","createMessage","data","sender","prisma","user","findUnique","where","id","senderId","select","role","request","chatRequest","senderId_receiverId","receiverId","status","Error","message","chatMessage","create","mediaUrl","type","notificationsService","sendChatRequest","firstMessage","receiver","handleRequest","requestId","update","toLowerCase","getMessages","userId","contactId","findMany","OR","orderBy","timestamp","getChatList","sent","distinct","received","contactIds","Set","map","s","r","filter","Boolean","in","name","email","parentOf","include","student","getPendingRequests","teacherId","getSentRequests"],"mappings":"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"}