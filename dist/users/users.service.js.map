{"version":3,"sources":["../../src/users/users.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport * as crypto from 'crypto';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { NotificationsService } from '../notifications/notifications.service';\nimport { User, Prisma } from '@prisma/client';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    private prisma: PrismaService,\n    private notificationsService: NotificationsService,\n  ) {}\n\n  async findOne(email: string): Promise<User | null> {\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n      include: {\n        assignedByTeacher: { select: { name: true } },\n        parentOf: {\n          include: {\n            student: {\n              select: {\n                id: true,\n                name: true,\n                email: true,\n                grade: true,\n                medal: true,\n                profileSlug: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (user && (!user.profileSlug || !user.profileSettings)) {\n      const updateData: any = {};\n      if (!user.profileSlug) updateData.profileSlug = crypto.randomUUID();\n      if (!user.profileSettings) {\n        updateData.profileSettings = {\n          showMedals: true,\n          showGrades: true,\n          showCourses: true,\n          showTestResults: true,\n        };\n      }\n      return this.prisma.user.update({\n        where: { id: user.id },\n        data: updateData,\n      });\n    }\n    return user;\n  }\n\n  async findById(id: string): Promise<User | null> {\n    const user = await this.prisma.user.findUnique({\n      where: { id },\n      include: {\n        assignedByTeacher: { select: { name: true } },\n        parentOf: {\n          include: {\n            student: {\n              select: {\n                id: true,\n                name: true,\n                email: true,\n                grade: true,\n                medal: true,\n                profileSlug: true,\n              },\n            },\n          },\n        },\n        parentRequests: {\n          orderBy: { createdAt: 'desc' },\n        },\n        enrollments: {\n          include: {\n            course: {\n              select: { id: true, title: true, thumbnail: true },\n            },\n          },\n        },\n        practiceTestResults: {\n          include: {\n            test: { select: { id: true, title: true } },\n          },\n          orderBy: { createdAt: 'desc' },\n        },\n      },\n    });\n\n    if (user && !user.profileSlug) {\n      return this.prisma.user.update({\n        where: { id: user.id },\n        data: { profileSlug: crypto.randomUUID() },\n      });\n    }\n    return user;\n  }\n\n  async findAllStudents() {\n    return await this.prisma.user.findMany({\n      where: { role: 'STUDENT' },\n      select: {\n        id: true,\n        name: true,\n        email: true,\n        medal: true,\n        grade: true,\n        academicAssignedAt: true,\n        assignedByTeacher: { select: { name: true } },\n        _count: {\n          select: {\n            enrollments: true,\n            practiceTestResults: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async updateAcademicStatus(\n    studentId: string,\n    teacherId: string,\n    data: { medal?: any; grade?: any },\n  ) {\n    return await this.prisma.user.update({\n      where: { id: studentId },\n      data: {\n        medal: data.medal,\n        grade: data.grade,\n        assignedByTeacherId: teacherId,\n        academicAssignedAt: new Date(),\n      },\n    });\n  }\n\n  async create(data: Prisma.UserCreateInput): Promise<User> {\n    return this.prisma.user.create({\n      data,\n    });\n  }\n\n  async update(id: string, data: Prisma.UserUpdateInput): Promise<User> {\n    return this.prisma.user.update({\n      where: { id },\n      data,\n    });\n  }\n\n  // Parent Portal Methods\n\n  async createParentRequest(parentId: string, studentEmail: string) {\n    // Check if already linked\n    const student = await this.prisma.user.findUnique({ where: { email: studentEmail } });\n    if (student) {\n      const existingLink = await this.prisma.parentStudent.findUnique({\n        where: { parentId_studentId: { parentId, studentId: student.id } }\n      });\n      if (existingLink) throw new Error('Student is already linked to your account');\n    }\n\n    // Check for pending request\n    const existingRequest = await this.prisma.parentRequest.findFirst({\n      where: {\n        parentId,\n        studentEmail,\n        status: 'PENDING',\n      },\n    });\n\n    if (existingRequest) {\n      throw new Error('A pending request already exists for this student');\n    }\n\n    return this.prisma.parentRequest.create({\n      data: {\n        parentId,\n        studentEmail,\n        status: 'PENDING',\n      },\n    });\n  }\n\n  async getPendingRequests() {\n    return this.prisma.parentRequest.findMany({\n      where: { status: 'PENDING' },\n      include: { parent: { select: { id: true, name: true, email: true } } },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async approveRequest(requestId: string) {\n    const request = await this.prisma.parentRequest.findUnique({\n      where: { id: requestId },\n      include: { parent: true },\n    });\n\n    if (!request) throw new Error('Request not found');\n\n    // Find student by email\n    const student = await this.prisma.user.findUnique({\n      where: { email: request.studentEmail },\n    });\n\n    if (!student) throw new Error('Student not found');\n\n    // Create link\n    await this.prisma.parentStudent.create({\n      data: {\n        parentId: request.parentId,\n        studentId: student.id,\n      },\n    });\n\n    // Update request\n    await this.prisma.parentRequest.update({\n      where: { id: requestId },\n      data: { status: 'APPROVED' },\n    });\n\n    // Notify Student\n    await this.notificationsService.create(\n      student.id,\n      'Parent Linked',\n      `${request.parent.name} has been linked as your parent. If this is incorrect, please report to admin.`,\n      'ALERT',\n    );\n\n    return { success: true };\n  }\n\n  async rejectRequest(requestId: string) {\n    return this.prisma.parentRequest.update({\n      where: { id: requestId },\n      data: { status: 'REJECTED' },\n    });\n  }\n\n  async manualLinkParentStudent(parentId: string, studentEmail: string) {\n    const student = await this.prisma.user.findUnique({\n      where: { email: studentEmail },\n    });\n    const parent = await this.prisma.user.findUnique({\n      where: { id: parentId },\n    });\n\n    if (!student || !parent) throw new Error('User not found');\n\n    // Create link\n    await this.prisma.parentStudent.create({\n      data: { parentId, studentId: student.id },\n    });\n\n    // Notify Student\n    await this.notificationsService.create(\n      student.id,\n      'Parent Linked',\n      `${parent.name} has been linked as your parent by Admin. If this is incorrect, please report.`,\n      'ALERT',\n    );\n    // Notify Parent\n    await this.notificationsService.create(\n      parent.id,\n      'Student Linked',\n      `You have been linked to student ${student.name} by Admin.`,\n      'INFO',\n    );\n\n    return { success: true };\n  }\n\n  async getStudentData(parentId: string, studentId: string) {\n    // Verify parent-student link\n    const link = await this.prisma.parentStudent.findUnique({\n      where: { parentId_studentId: { parentId, studentId } },\n    });\n\n    if (!link) {\n      throw new Error('Not authorized to view this student data');\n    }\n\n    return this.prisma.user.findUnique({\n      where: { id: studentId },\n      include: {\n        enrollments: { include: { course: true } },\n        assignedCourses: { include: { course: true } },\n        practiceTestResults: {\n          include: { test: true },\n          take: 20,\n          orderBy: { createdAt: 'desc' },\n        },\n        loginHistory: {\n          take: 10,\n          orderBy: { loginTime: 'desc' },\n        },\n        assignedByTeacher: { select: { name: true, email: true } },\n      },\n    });\n  }\n\n  async findAllTeachers() {\n    return this.prisma.user.findMany({\n      where: { role: 'TEACHER' },\n      select: {\n        id: true,\n        name: true,\n        email: true,\n        role: true,\n      },\n    });\n  }\n\n  async findAllParents() {\n    return this.prisma.user.findMany({\n      where: { role: 'PARENT' },\n      select: {\n        id: true,\n        name: true,\n        email: true,\n        role: true,\n        parentOf: {\n          include: {\n            student: {\n              select: { name: true }\n            }\n          }\n        }\n      },\n    });\n  }\n}\n"],"names":["UsersService","findOne","email","user","prisma","findUnique","where","include","assignedByTeacher","select","name","parentOf","student","id","grade","medal","profileSlug","profileSettings","updateData","crypto","randomUUID","showMedals","showGrades","showCourses","showTestResults","update","data","findById","parentRequests","orderBy","createdAt","enrollments","course","title","thumbnail","practiceTestResults","test","findAllStudents","findMany","role","academicAssignedAt","_count","updateAcademicStatus","studentId","teacherId","assignedByTeacherId","Date","create","createParentRequest","parentId","studentEmail","existingLink","parentStudent","parentId_studentId","Error","existingRequest","parentRequest","findFirst","status","getPendingRequests","parent","approveRequest","requestId","request","notificationsService","success","rejectRequest","manualLinkParentStudent","getStudentData","link","assignedCourses","take","loginHistory","loginTime","findAllTeachers","findAllParents"],"mappings":"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"}