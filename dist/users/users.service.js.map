{"version":3,"sources":["../../src/users/users.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { NotificationsService } from '../notifications/notifications.service';\nimport { User, Prisma } from '@prisma/client';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    private prisma: PrismaService,\n    private notificationsService: NotificationsService,\n  ) {}\n\n  async findOne(email: string): Promise<User | null> {\n    return this.prisma.user.findUnique({\n      where: { email },\n      include: {\n        assignedByTeacher: { select: { name: true } },\n        parentOf: {\n          include: {\n            student: {\n              select: {\n                id: true,\n                name: true,\n                email: true,\n                grade: true,\n                medal: true,\n              },\n            },\n          },\n        },\n      },\n    });\n  }\n\n  async findById(id: string): Promise<User | null> {\n    return this.prisma.user.findUnique({\n      where: { id },\n      include: {\n        assignedByTeacher: { select: { name: true } },\n        parentOf: {\n          include: {\n            student: {\n              select: {\n                id: true,\n                name: true,\n                email: true,\n                grade: true,\n                medal: true,\n              },\n            },\n          },\n        },\n        parentRequests: {\n          orderBy: { createdAt: 'desc' },\n        },\n      },\n    });\n  }\n\n  async findAllStudents() {\n    return await this.prisma.user.findMany({\n      where: { role: 'STUDENT' },\n      select: {\n        id: true,\n        name: true,\n        email: true,\n        medal: true,\n        grade: true,\n        academicAssignedAt: true,\n        assignedByTeacher: { select: { name: true } },\n        _count: {\n          select: {\n            enrollments: true,\n            practiceTestResults: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async updateAcademicStatus(\n    studentId: string,\n    teacherId: string,\n    data: { medal?: any; grade?: any },\n  ) {\n    return await this.prisma.user.update({\n      where: { id: studentId },\n      data: {\n        medal: data.medal,\n        grade: data.grade,\n        assignedByTeacherId: teacherId,\n        academicAssignedAt: new Date(),\n      },\n    });\n  }\n\n  async create(data: Prisma.UserCreateInput): Promise<User> {\n    return this.prisma.user.create({\n      data,\n    });\n  }\n\n  async update(id: string, data: Prisma.UserUpdateInput): Promise<User> {\n    return this.prisma.user.update({\n      where: { id },\n      data,\n    });\n  }\n\n  // Parent Portal Methods\n\n  async createParentRequest(parentId: string, studentEmail: string) {\n    // Check if already linked\n    const student = await this.prisma.user.findUnique({ where: { email: studentEmail } });\n    if (student) {\n      const existingLink = await this.prisma.parentStudent.findUnique({\n        where: { parentId_studentId: { parentId, studentId: student.id } }\n      });\n      if (existingLink) throw new Error('Student is already linked to your account');\n    }\n\n    // Check for pending request\n    const existingRequest = await this.prisma.parentRequest.findFirst({\n      where: {\n        parentId,\n        studentEmail,\n        status: 'PENDING',\n      },\n    });\n\n    if (existingRequest) {\n      throw new Error('A pending request already exists for this student');\n    }\n\n    return this.prisma.parentRequest.create({\n      data: {\n        parentId,\n        studentEmail,\n        status: 'PENDING',\n      },\n    });\n  }\n\n  async getPendingRequests() {\n    return this.prisma.parentRequest.findMany({\n      where: { status: 'PENDING' },\n      include: { parent: { select: { id: true, name: true, email: true } } },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  async approveRequest(requestId: string) {\n    const request = await this.prisma.parentRequest.findUnique({\n      where: { id: requestId },\n      include: { parent: true },\n    });\n\n    if (!request) throw new Error('Request not found');\n\n    // Find student by email\n    const student = await this.prisma.user.findUnique({\n      where: { email: request.studentEmail },\n    });\n\n    if (!student) throw new Error('Student not found');\n\n    // Create link\n    await this.prisma.parentStudent.create({\n      data: {\n        parentId: request.parentId,\n        studentId: student.id,\n      },\n    });\n\n    // Update request\n    await this.prisma.parentRequest.update({\n      where: { id: requestId },\n      data: { status: 'APPROVED' },\n    });\n\n    // Notify Student\n    await this.notificationsService.create(\n      student.id,\n      'Parent Linked',\n      `${request.parent.name} has been linked as your parent. If this is incorrect, please report to admin.`,\n      'ALERT',\n    );\n\n    return { success: true };\n  }\n\n  async rejectRequest(requestId: string) {\n    return this.prisma.parentRequest.update({\n      where: { id: requestId },\n      data: { status: 'REJECTED' },\n    });\n  }\n\n  async manualLinkParentStudent(parentId: string, studentEmail: string) {\n    const student = await this.prisma.user.findUnique({\n      where: { email: studentEmail },\n    });\n    const parent = await this.prisma.user.findUnique({\n      where: { id: parentId },\n    });\n\n    if (!student || !parent) throw new Error('User not found');\n\n    // Create link\n    await this.prisma.parentStudent.create({\n      data: { parentId, studentId: student.id },\n    });\n\n    // Notify Student\n    await this.notificationsService.create(\n      student.id,\n      'Parent Linked',\n      `${parent.name} has been linked as your parent by Admin. If this is incorrect, please report.`,\n      'ALERT',\n    );\n    // Notify Parent\n    await this.notificationsService.create(\n      parent.id,\n      'Student Linked',\n      `You have been linked to student ${student.name} by Admin.`,\n      'INFO',\n    );\n\n    return { success: true };\n  }\n\n  async getStudentData(parentId: string, studentId: string) {\n    // Verify parent-student link\n    const link = await this.prisma.parentStudent.findUnique({\n      where: { parentId_studentId: { parentId, studentId } },\n    });\n\n    if (!link) {\n      throw new Error('Not authorized to view this student data');\n    }\n\n    return this.prisma.user.findUnique({\n      where: { id: studentId },\n      include: {\n        enrollments: { include: { course: true } },\n        assignedCourses: { include: { course: true } },\n        practiceTestResults: {\n          include: { test: true },\n          take: 20,\n          orderBy: { createdAt: 'desc' },\n        },\n        loginHistory: {\n          take: 10,\n          orderBy: { loginTime: 'desc' },\n        },\n        assignedByTeacher: { select: { name: true, email: true } },\n      },\n    });\n  }\n}\n"],"names":["UsersService","findOne","email","prisma","user","findUnique","where","include","assignedByTeacher","select","name","parentOf","student","id","grade","medal","findById","parentRequests","orderBy","createdAt","findAllStudents","findMany","role","academicAssignedAt","_count","enrollments","practiceTestResults","updateAcademicStatus","studentId","teacherId","data","update","assignedByTeacherId","Date","create","createParentRequest","parentId","studentEmail","existingLink","parentStudent","parentId_studentId","Error","existingRequest","parentRequest","findFirst","status","getPendingRequests","parent","approveRequest","requestId","request","notificationsService","success","rejectRequest","manualLinkParentStudent","getStudentData","link","course","assignedCourses","test","take","loginHistory","loginTime"],"mappings":"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"}