{"version":3,"sources":["../../src/users/users.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Patch,\n  Post,\n  Body,\n  UseGuards,\n  Request,\n  Param,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { UsersService } from './users.service';\nimport { JwtAuthGuard } from '../auth/jwt-auth.guard';\n\n@Controller('users')\nexport class UsersController {\n  constructor(private readonly usersService: UsersService) {}\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  getProfile(@Request() req) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    return this.usersService.findById(userId);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Patch('profile')\n  async updateProfile(@Request() req, @Body() updateData: any) {\n    const userId = req.user.userId || req.user.sub || req.user.id;\n\n    if (updateData.password) {\n      const bcrypt = await import('bcrypt');\n      updateData.password = await bcrypt.hash(updateData.password, 10);\n    }\n\n    return this.usersService.update(userId, updateData);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('students')\n  async getAllStudents(@Request() req) {\n    const role =\n      req.user.role ||\n      (\n        await this.usersService.findById(\n          req.user.userId || req.user.id || req.user.sub,\n        )\n      )?.role;\n\n    if (role !== 'TEACHER' && role !== 'ADMIN') {\n      throw new ForbiddenException(\n        'Only teachers or admins can view all students',\n      );\n    }\n    return this.usersService.findAllStudents();\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Patch(':id/academic-status')\n  async updateAcademicStatus(\n    @Param('id') studentId: string,\n    @Request() req,\n    @Body() data: any,\n  ) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    const user = await this.usersService.findById(userId);\n    const role = user?.role || req.user.role;\n\n    if (role !== 'TEACHER' && role !== 'ADMIN') {\n      console.log(`Access denied for user ${userId} with role ${role}`);\n      throw new ForbiddenException(\n        'Only teachers or admins can update student academic status',\n      );\n    }\n\n    return this.usersService.updateAcademicStatus(studentId, userId, data);\n  }\n\n  // Parent Portal Endpoints\n\n  @UseGuards(JwtAuthGuard)\n  @Post('parent-request')\n  async createParentRequest(\n    @Request() req,\n    @Body() body: { studentEmail: string },\n  ) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    return this.usersService.createParentRequest(userId, body.studentEmail);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('admin/parent-requests')\n  async getPendingRequests(@Request() req) {\n    // Should ideally check for Admin role here\n    return this.usersService.getPendingRequests();\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/parent-request/:id/approve')\n  async approveRequest(@Param('id') id: string) {\n    return this.usersService.approveRequest(id);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/parent-request/:id/reject')\n  async rejectRequest(@Param('id') id: string) {\n    return this.usersService.rejectRequest(id);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/link-parent-student')\n  async manualLinkParentStudent(\n    @Body() body: { parentId: string; studentEmail: string },\n  ) {\n    return this.usersService.manualLinkParentStudent(\n      body.parentId,\n      body.studentEmail,\n    );\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('parent/student-data/:studentId')\n  async getStudentData(@Param('studentId') studentId: string, @Request() req) {\n    const parentId = req.user.userId || req.user.id || req.user.sub;\n    return this.usersService.getStudentData(parentId, studentId);\n  }\n}\n"],"names":["UsersController","getProfile","req","userId","user","id","sub","usersService","findById","updateProfile","updateData","password","bcrypt","hash","update","getAllStudents","role","ForbiddenException","findAllStudents","updateAcademicStatus","studentId","data","console","log","createParentRequest","body","studentEmail","getPendingRequests","approveRequest","rejectRequest","manualLinkParentStudent","parentId","getStudentData"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBALN;8BACsB;8BACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGtB,IAAA,AAAMA,kBAAN,MAAMA;IAKXC,WAAW,AAAWC,GAAG,EAAE;QACzB,MAAMC,SAASD,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACC,EAAE,IAAIH,IAAIE,IAAI,CAACE,GAAG;QAC7D,OAAO,IAAI,CAACC,YAAY,CAACC,QAAQ,CAACL;IACpC;IAEA,MAEMM,cAAc,AAAWP,GAAG,EAAE,AAAQQ,UAAe,EAAE;QAC3D,MAAMP,SAASD,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACE,GAAG,IAAIJ,IAAIE,IAAI,CAACC,EAAE;QAE7D,IAAIK,WAAWC,QAAQ,EAAE;YACvB,MAAMC,SAAS,MAAM,mEAAA,QAAO;YAC5BF,WAAWC,QAAQ,GAAG,MAAMC,OAAOC,IAAI,CAACH,WAAWC,QAAQ,EAAE;QAC/D;QAEA,OAAO,IAAI,CAACJ,YAAY,CAACO,MAAM,CAACX,QAAQO;IAC1C;IAEA,MAEMK,eAAe,AAAWb,GAAG,EAAE;QACnC,MAAMc,OACJd,IAAIE,IAAI,CAACY,IAAI,IAEX,CAAA,MAAM,IAAI,CAACT,YAAY,CAACC,QAAQ,CAC9BN,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACC,EAAE,IAAIH,IAAIE,IAAI,CAACE,GAAG,CAChD,GACCU;QAEL,IAAIA,SAAS,aAAaA,SAAS,SAAS;YAC1C,MAAM,IAAIC,0BAAkB,CAC1B;QAEJ;QACA,OAAO,IAAI,CAACV,YAAY,CAACW,eAAe;IAC1C;IAEA,MAEMC,qBACJ,AAAaC,SAAiB,EAC9B,AAAWlB,GAAG,EACd,AAAQmB,IAAS,EACjB;QACA,MAAMlB,SAASD,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACC,EAAE,IAAIH,IAAIE,IAAI,CAACE,GAAG;QAC7D,MAAMF,OAAO,MAAM,IAAI,CAACG,YAAY,CAACC,QAAQ,CAACL;QAC9C,MAAMa,OAAOZ,MAAMY,QAAQd,IAAIE,IAAI,CAACY,IAAI;QAExC,IAAIA,SAAS,aAAaA,SAAS,SAAS;YAC1CM,QAAQC,GAAG,CAAC,CAAC,uBAAuB,EAAEpB,OAAO,WAAW,EAAEa,MAAM;YAChE,MAAM,IAAIC,0BAAkB,CAC1B;QAEJ;QAEA,OAAO,IAAI,CAACV,YAAY,CAACY,oBAAoB,CAACC,WAAWjB,QAAQkB;IACnE;IAEA,0BAA0B;IAE1B,MAEMG,oBACJ,AAAWtB,GAAG,EACd,AAAQuB,IAA8B,EACtC;QACA,MAAMtB,SAASD,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACC,EAAE,IAAIH,IAAIE,IAAI,CAACE,GAAG;QAC7D,OAAO,IAAI,CAACC,YAAY,CAACiB,mBAAmB,CAACrB,QAAQsB,KAAKC,YAAY;IACxE;IAEA,MAEMC,mBAAmB,AAAWzB,GAAG,EAAE;QACvC,2CAA2C;QAC3C,OAAO,IAAI,CAACK,YAAY,CAACoB,kBAAkB;IAC7C;IAEA,MAEMC,eAAe,AAAavB,EAAU,EAAE;QAC5C,OAAO,IAAI,CAACE,YAAY,CAACqB,cAAc,CAACvB;IAC1C;IAEA,MAEMwB,cAAc,AAAaxB,EAAU,EAAE;QAC3C,OAAO,IAAI,CAACE,YAAY,CAACsB,aAAa,CAACxB;IACzC;IAEA,MAEMyB,wBACJ,AAAQL,IAAgD,EACxD;QACA,OAAO,IAAI,CAAClB,YAAY,CAACuB,uBAAuB,CAC9CL,KAAKM,QAAQ,EACbN,KAAKC,YAAY;IAErB;IAEA,MAEMM,eAAe,AAAoBZ,SAAiB,EAAE,AAAWlB,GAAG,EAAE;QAC1E,MAAM6B,WAAW7B,IAAIE,IAAI,CAACD,MAAM,IAAID,IAAIE,IAAI,CAACC,EAAE,IAAIH,IAAIE,IAAI,CAACE,GAAG;QAC/D,OAAO,IAAI,CAACC,YAAY,CAACyB,cAAc,CAACD,UAAUX;IACpD;IA7GA,YAAY,AAAiBb,YAA0B,CAAE;aAA5BA,eAAAA;IAA6B;AA8G5D"}