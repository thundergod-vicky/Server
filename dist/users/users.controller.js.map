{"version":3,"sources":["../../src/users/users.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Patch,\n  Post,\n  Body,\n  UseGuards,\n  Request,\n  Param,\n  ForbiddenException,\n  UseInterceptors,\n  UploadedFile,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiExcludeEndpoint,\n} from '@nestjs/swagger';\nimport { UsersService } from './users.service';\nimport { JwtAuthGuard } from '../auth/jwt-auth.guard';\nimport { UpdateProfileDto } from './dto/update-profile.dto';\nimport { UpdateAcademicStatusDto } from './dto/update-academic-status.dto';\nimport { ParentRequestDto } from './dto/parent-request.dto';\nimport { LinkParentStudentDto } from './dto/link-parent-student.dto';\n\nimport { S3Service } from '../content/s3.service';\n\ninterface RequestWithUser {\n  user: {\n    userId?: string;\n    id?: string;\n    sub?: string;\n    role?: string;\n  };\n}\n\n@ApiTags('Users')\n@ApiBearerAuth()\n@Controller('users')\nexport class UsersController {\n  constructor(\n    private readonly usersService: UsersService,\n    private readonly s3Service: S3Service,\n  ) {}\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  @ApiOperation({ summary: 'Get current user profile' })\n  @ApiResponse({ status: 200, description: 'Return user profile' })\n  getProfile(@Request() req: RequestWithUser) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    if (!userId) throw new ForbiddenException('User ID not found');\n    return this.usersService.findById(userId);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Patch('profile')\n  @ApiOperation({ summary: 'Update current user profile' })\n  @ApiResponse({ status: 200, description: 'Profile updated successfully' })\n  async updateProfile(\n    @Request() req: RequestWithUser,\n    @Body() updateData: UpdateProfileDto,\n  ) {\n    const userId = req.user.userId || req.user.sub || req.user.id;\n    if (!userId) throw new ForbiddenException('User ID not found');\n\n    if (updateData.password) {\n      const bcrypt = await import('bcrypt');\n      updateData.password = await bcrypt.hash(updateData.password, 10);\n    }\n\n    // Cast to any to bypass strict Prisma input type if DTO doesn't match perfectly\n    return this.usersService.update(userId, updateData as any);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('profile-image')\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiOperation({ summary: 'Upload profile image' })\n  async uploadProfileImage(\n    @Request() req: RequestWithUser,\n    @UploadedFile() file: Express.Multer.File,\n  ) {\n    const userId = req.user.userId || req.user.sub || req.user.id;\n    if (!userId) throw new ForbiddenException('User ID not found');\n\n    const uploadResult = await this.s3Service.uploadFile(file);\n    console.log('Upload Result:', uploadResult);\n    // Store the S3 key (id) so it can be routed through our secure stream endpoint\n    const result = await this.usersService.update(userId, {\n      profileImage: uploadResult.id,\n    });\n    console.log('Updated User Profile Image:', result?.profileImage);\n    return result;\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('profile-image/reset')\n  @ApiOperation({ summary: 'Remove profile image and reset to random avatar' })\n  async resetProfileImage(@Request() req: RequestWithUser) {\n    const userId = req.user.userId || req.user.sub || req.user.id;\n    if (!userId) throw new ForbiddenException('User ID not found');\n    return this.usersService.resetProfileImage(userId);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('students')\n  @ApiOperation({ summary: 'Get all students (Teachers/Admins only)' })\n  @ApiResponse({ status: 200, description: 'Return all students' })\n  @ApiResponse({ status: 403, description: 'Forbidden' })\n  async getAllStudents(@Request() req: RequestWithUser) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    if (!userId) throw new ForbiddenException('User ID not found');\n\n    const role =\n      req.user.role || (await this.usersService.findById(userId))?.role;\n\n    if (role !== 'TEACHER' && role !== 'ADMIN') {\n      throw new ForbiddenException(\n        'Only teachers or admins can view all students',\n      );\n    }\n    return this.usersService.findAllStudents();\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Patch(':id/academic-status')\n  @ApiOperation({\n    summary: 'Update student academic status (Teachers/Admins only)',\n  })\n  @ApiResponse({ status: 200, description: 'Status updated' })\n  async updateAcademicStatus(\n    @Param('id') studentId: string,\n    @Request() req: RequestWithUser,\n    @Body() data: UpdateAcademicStatusDto,\n  ) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    if (!userId) throw new ForbiddenException('User ID not found');\n\n    const user = await this.usersService.findById(userId);\n    const role = user?.role || req.user.role;\n\n    if (role !== 'TEACHER' && role !== 'ADMIN') {\n      console.log(`Access denied for user ${userId} with role ${role}`);\n      throw new ForbiddenException(\n        'Only teachers or admins can update student academic status',\n      );\n    }\n\n    return this.usersService.updateAcademicStatus(studentId, userId, data);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Post('parent-request')\n  @ApiOperation({ summary: 'Create a parent-student link request' })\n  @ApiResponse({ status: 201, description: 'Request created' })\n  async createParentRequest(\n    @Request() req: RequestWithUser,\n    @Body() body: ParentRequestDto,\n  ) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    if (!userId) throw new ForbiddenException('User ID not found');\n    return this.usersService.createParentRequest(userId, body.studentEmail);\n  }\n\n  @ApiExcludeEndpoint()\n  @UseGuards(JwtAuthGuard)\n  @Get('admin/parent-requests')\n  @ApiOperation({ summary: 'Get all pending parent requests (Admins only)' })\n  @ApiResponse({ status: 200, description: 'Return pending requests' })\n  getPendingRequests() {\n    return this.usersService.getPendingRequests();\n  }\n\n  @ApiExcludeEndpoint()\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/parent-request/:id/approve')\n  @ApiOperation({ summary: 'Approve a parent request (Admins only)' })\n  @ApiResponse({ status: 200, description: 'Request approved' })\n  async approveRequest(@Param('id') id: string) {\n    return this.usersService.approveRequest(id);\n  }\n\n  @ApiExcludeEndpoint()\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/parent-request/:id/reject')\n  @ApiOperation({ summary: 'Reject a parent request (Admins only)' })\n  @ApiResponse({ status: 200, description: 'Request rejected' })\n  async rejectRequest(@Param('id') id: string) {\n    return this.usersService.rejectRequest(id);\n  }\n\n  @ApiExcludeEndpoint()\n  @UseGuards(JwtAuthGuard)\n  @Post('admin/link-parent-student')\n  @ApiOperation({ summary: 'Manually link parent and student (Admins only)' })\n  @ApiResponse({ status: 201, description: 'Linked successfully' })\n  async manualLinkParentStudent(@Body() body: LinkParentStudentDto) {\n    return this.usersService.manualLinkParentStudent(\n      body.parentId,\n      body.studentEmail,\n    );\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('parent/student-data/:studentId')\n  @ApiOperation({ summary: 'Get linked student data (Parents only)' })\n  @ApiResponse({ status: 200, description: 'Return student data' })\n  async getStudentData(\n    @Param('studentId') studentId: string,\n    @Request() req: RequestWithUser,\n  ) {\n    const parentId = req.user.userId || req.user.id || req.user.sub;\n    if (!parentId) throw new ForbiddenException('Parent ID not found');\n    return this.usersService.getStudentData(parentId, studentId);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('teachers')\n  @ApiOperation({ summary: 'Get all teachers for messaging directory' })\n  async getTeachers() {\n    return this.usersService.findAllTeachers();\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('parents')\n  @ApiOperation({ summary: 'Get all parents (Teachers/Admins only)' })\n  async getParents(@Request() req: RequestWithUser) {\n    const userId = req.user.userId || req.user.id || req.user.sub;\n    if (!userId) throw new ForbiddenException('User ID not found');\n\n    const role = req.user.role || (await this.usersService.findById(userId))?.role;\n    if (role !== 'TEACHER' && role !== 'ADMIN') {\n      throw new ForbiddenException('Only teachers or admins can view parents');\n    }\n    return this.usersService.findAllParents();\n  }\n}\n"],"names":["UsersController","getProfile","req","userId","user","id","sub","ForbiddenException","usersService","findById","updateProfile","updateData","password","bcrypt","hash","update","uploadProfileImage","file","uploadResult","s3Service","uploadFile","console","log","result","profileImage","resetProfileImage","getAllStudents","role","findAllStudents","updateAcademicStatus","studentId","data","createParentRequest","body","studentEmail","getPendingRequests","approveRequest","rejectRequest","manualLinkParentStudent","parentId","getStudentData","getTeachers","findAllTeachers","getParents","findAllParents","summary","status","description"],"mappings":"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"}