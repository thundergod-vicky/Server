{"version":3,"sources":["../../src/public/public.controller.ts"],"sourcesContent":["import { Controller, Get, Param, NotFoundException } from '@nestjs/common';\nimport { ApiTags, ApiOperation } from '@nestjs/swagger';\nimport { PrismaService } from '../prisma/prisma.service';\n\n@ApiTags('Public')\n@Controller('public')\nexport class PublicController {\n  constructor(private prisma: PrismaService) {}\n\n  @Get('profile/:slug')\n  @ApiOperation({ summary: 'Get student public profile by slug' })\n  async getPublicProfile(@Param('slug') slug: string) {\n    const student = await this.prisma.user.findUnique({\n      where: { profileSlug: slug },\n      select: {\n        id: true,\n        name: true,\n        medal: true,\n        grade: true,\n        academicAssignedAt: true,\n        profileSettings: true,\n        assignedByTeacher: {\n          select: { name: true },\n        },\n        enrollments: {\n          include: {\n            course: {\n              select: { title: true, thumbnail: true },\n            },\n          },\n        },\n        practiceTestResults: {\n          include: {\n            test: { select: { title: true } },\n          },\n          orderBy: { createdAt: 'desc' },\n          take: 10,\n        },\n      },\n    });\n\n    if (!student) {\n      throw new NotFoundException('Profile not found');\n    }\n\n    const settings = (student.profileSettings as any) || {\n      showMedals: true,\n      showGrades: true,\n      showCourses: true,\n      showTestResults: true,\n    };\n\n    const enrollments = settings.showCourses \n      ? student.enrollments.filter(e => !settings.hiddenCourseIds?.includes(e.courseId))\n      : [];\n\n    const practiceTestResults = settings.showTestResults\n      ? student.practiceTestResults.filter(r => !settings.hiddenTestResultIds?.includes(r.id))\n      : [];\n\n    return {\n      id: student.id,\n      name: student.name,\n      profileSettings: student.profileSettings,\n      medal: settings.showMedals ? student.medal : null,\n      grade: settings.showGrades ? student.grade : null,\n      academicAssignedAt: (settings.showMedals || settings.showGrades) ? student.academicAssignedAt : null,\n      assignedByTeacher: (settings.showMedals || settings.showGrades) ? student.assignedByTeacher : null,\n      enrollments,\n      practiceTestResults,\n    };\n  }\n}\n"],"names":["PublicController","getPublicProfile","slug","student","prisma","user","findUnique","where","profileSlug","select","id","name","medal","grade","academicAssignedAt","profileSettings","assignedByTeacher","enrollments","include","course","title","thumbnail","practiceTestResults","test","orderBy","createdAt","take","NotFoundException","settings","showMedals","showGrades","showCourses","showTestResults","filter","e","hiddenCourseIds","includes","courseId","r","hiddenTestResultIds","summary"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBAN6C;yBACpB;+BACR;;;;;;;;;;;;;;;AAIvB,IAAA,AAAMA,mBAAN,MAAMA;IAGX,MAEMC,iBAAiB,AAAeC,IAAY,EAAE;QAClD,MAAMC,UAAU,MAAM,IAAI,CAACC,MAAM,CAACC,IAAI,CAACC,UAAU,CAAC;YAChDC,OAAO;gBAAEC,aAAaN;YAAK;YAC3BO,QAAQ;gBACNC,IAAI;gBACJC,MAAM;gBACNC,OAAO;gBACPC,OAAO;gBACPC,oBAAoB;gBACpBC,iBAAiB;gBACjBC,mBAAmB;oBACjBP,QAAQ;wBAAEE,MAAM;oBAAK;gBACvB;gBACAM,aAAa;oBACXC,SAAS;wBACPC,QAAQ;4BACNV,QAAQ;gCAAEW,OAAO;gCAAMC,WAAW;4BAAK;wBACzC;oBACF;gBACF;gBACAC,qBAAqB;oBACnBJ,SAAS;wBACPK,MAAM;4BAAEd,QAAQ;gCAAEW,OAAO;4BAAK;wBAAE;oBAClC;oBACAI,SAAS;wBAAEC,WAAW;oBAAO;oBAC7BC,MAAM;gBACR;YACF;QACF;QAEA,IAAI,CAACvB,SAAS;YACZ,MAAM,IAAIwB,yBAAiB,CAAC;QAC9B;QAEA,MAAMC,WAAW,AAACzB,QAAQY,eAAe,IAAY;YACnDc,YAAY;YACZC,YAAY;YACZC,aAAa;YACbC,iBAAiB;QACnB;QAEA,MAAMf,cAAcW,SAASG,WAAW,GACpC5B,QAAQc,WAAW,CAACgB,MAAM,CAACC,CAAAA,IAAK,CAACN,SAASO,eAAe,EAAEC,SAASF,EAAEG,QAAQ,KAC9E,EAAE;QAEN,MAAMf,sBAAsBM,SAASI,eAAe,GAChD7B,QAAQmB,mBAAmB,CAACW,MAAM,CAACK,CAAAA,IAAK,CAACV,SAASW,mBAAmB,EAAEH,SAASE,EAAE5B,EAAE,KACpF,EAAE;QAEN,OAAO;YACLA,IAAIP,QAAQO,EAAE;YACdC,MAAMR,QAAQQ,IAAI;YAClBI,iBAAiBZ,QAAQY,eAAe;YACxCH,OAAOgB,SAASC,UAAU,GAAG1B,QAAQS,KAAK,GAAG;YAC7CC,OAAOe,SAASE,UAAU,GAAG3B,QAAQU,KAAK,GAAG;YAC7CC,oBAAoB,AAACc,SAASC,UAAU,IAAID,SAASE,UAAU,GAAI3B,QAAQW,kBAAkB,GAAG;YAChGE,mBAAmB,AAACY,SAASC,UAAU,IAAID,SAASE,UAAU,GAAI3B,QAAQa,iBAAiB,GAAG;YAC9FC;YACAK;QACF;IACF;IAhEA,YAAY,AAAQlB,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AAiE9C;;;;QA9DkBoC,SAAS"}