{"version":3,"sources":["../../src/content/s3.service.ts"],"sourcesContent":["import { Injectable, InternalServerErrorException } from '@nestjs/common';\nimport { S3Client, GetObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';\nimport { Upload } from '@aws-sdk/lib-storage';\nimport { NodeHttpHandler } from '@smithy/node-http-handler';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { Readable } from 'stream';\n\n@Injectable()\nexport class S3Service {\n  private s3Client: S3Client;\n  private bucket: string;\n\n  constructor() {\n    const region = process.env.AWS_S3_REGION;\n    const accessKeyId = process.env.AWS_ACCESS_KEY_ID;\n    const secretAccessKey = process.env.AWS_SECRET_ACCESS_KEY;\n    const bucketName = process.env.AWS_S3_BUCKET_NAME;\n\n    if (!region || !accessKeyId || !secretAccessKey || !bucketName) {\n      throw new Error('AWS S3 credentials missing');\n    }\n\n    this.bucket = bucketName;\n\n    this.s3Client = new S3Client({\n      region,\n      credentials: {\n        accessKeyId,\n        secretAccessKey,\n      },\n      requestHandler: new NodeHttpHandler({\n        connectionTimeout: 60000,\n        requestTimeout: 120000,\n      }),\n    });\n  }\n\n  async uploadFile(file: Express.Multer.File) {\n    const timestamp = Date.now();\n    const path = `uploads/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\n    const region = process.env.AWS_S3_REGION;\n    const bucket = this.bucket;\n\n    const upload = new Upload({\n      client: this.s3Client,\n      params: {\n        Bucket: bucket,\n        Key: path,\n        Body: file.buffer,\n        ContentType: file.mimetype,\n      },\n      queueSize: 4,\n      partSize: 5 * 1024 * 1024,\n    });\n\n    try {\n      await upload.done();\n      const publicUrl = `https://${bucket}.s3.${region}.amazonaws.com/${path}`;\n      return {\n        id: path,\n        name: file.originalname,\n        mimeType: file.mimetype,\n        webViewLink: publicUrl,\n      };\n    } catch (error) {\n      console.error('S3 upload error:', error);\n      throw new InternalServerErrorException(\n        `Upload failed: ${(error as Error).message}`,\n      );\n    }\n  }\n\n  async getFileStream(fileId: string): Promise<Readable> {\n    const command = new GetObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const response = await this.s3Client.send(command);\n      return response.Body as Readable;\n    } catch (error) {\n      console.error('S3 download error:', {\n        fileId,\n        error: error,\n      });\n      throw new InternalServerErrorException(`Download failed: ${error.message}`);\n    }\n  }\n\n  async getFileMetadata(fileId: string) {\n    const command = new HeadObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const response = await this.s3Client.send(command);\n      return {\n        name: fileId.split('/').pop(),\n        mimeType: response.ContentType || 'application/octet-stream',\n      };\n    } catch (error) {\n      return {\n        name: fileId.split('/').pop(),\n        mimeType: 'application/octet-stream',\n      };\n    }\n  }\n\n  async createSignedUrl(fileId: string, expiresInSeconds: number = 60) {\n    const command = new GetObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const signedUrl = await getSignedUrl(this.s3Client, command, {\n        expiresIn: expiresInSeconds,\n      });\n      return { signedUrl };\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to create signed URL: ${error.message}`,\n      );\n    }\n  }\n}\n"],"names":["S3Service","uploadFile","file","timestamp","Date","now","path","originalname","replace","region","process","env","AWS_S3_REGION","bucket","upload","Upload","client","s3Client","params","Bucket","Key","Body","buffer","ContentType","mimetype","queueSize","partSize","done","publicUrl","id","name","mimeType","webViewLink","error","console","InternalServerErrorException","message","getFileStream","fileId","command","GetObjectCommand","response","send","getFileMetadata","HeadObjectCommand","split","pop","createSignedUrl","expiresInSeconds","signedUrl","getSignedUrl","expiresIn","accessKeyId","AWS_ACCESS_KEY_ID","secretAccessKey","AWS_SECRET_ACCESS_KEY","bucketName","AWS_S3_BUCKET_NAME","Error","S3Client","credentials","requestHandler","NodeHttpHandler","connectionTimeout","requestTimeout"],"mappings":"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"}