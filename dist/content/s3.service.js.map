{"version":3,"sources":["../../src/content/s3.service.ts"],"sourcesContent":["import { Injectable, InternalServerErrorException } from '@nestjs/common';\nimport { \n  S3Client, \n  PutObjectCommand, \n  GetObjectCommand,\n  HeadObjectCommand \n} from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { Readable } from 'stream';\n\n@Injectable()\nexport class S3Service {\n  private s3Client: S3Client;\n  private bucket: string;\n\n  constructor() {\n    const region = process.env.AWS_S3_REGION;\n    const accessKeyId = process.env.AWS_ACCESS_KEY_ID;\n    const secretAccessKey = process.env.AWS_SECRET_ACCESS_KEY;\n    const bucketName = process.env.AWS_S3_BUCKET_NAME;\n\n    if (!region || !accessKeyId || !secretAccessKey || !bucketName) {\n      throw new Error('AWS S3 credentials missing');\n    }\n\n    this.bucket = bucketName;\n\n    this.s3Client = new S3Client({\n      region,\n      credentials: {\n        accessKeyId,\n        secretAccessKey,\n      },\n    });\n  }\n\n  async uploadFile(file: Express.Multer.File) {\n    const timestamp = Date.now();\n    const path = `uploads/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\n\n    const command = new PutObjectCommand({\n      Bucket: this.bucket,\n      Key: path,\n      Body: file.buffer,\n      ContentType: file.mimetype,\n    });\n\n    try {\n      await this.s3Client.send(command);\n      return {\n        id: path, // We use the key as the ID\n        name: file.originalname,\n        mimeType: file.mimetype,\n        webViewLink: null,\n      };\n    } catch (error) {\n      throw new InternalServerErrorException(`Upload failed: ${error.message}`);\n    }\n  }\n\n  async getFileStream(fileId: string): Promise<Readable> {\n    const command = new GetObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const response = await this.s3Client.send(command);\n      return response.Body as Readable;\n    } catch (error) {\n      console.error('S3 download error:', {\n        fileId,\n        error: error,\n      });\n      throw new InternalServerErrorException(`Download failed: ${error.message}`);\n    }\n  }\n\n  async getFileMetadata(fileId: string) {\n    const command = new HeadObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const response = await this.s3Client.send(command);\n      return {\n        name: fileId.split('/').pop(),\n        mimeType: response.ContentType || 'application/octet-stream',\n      };\n    } catch (error) {\n      return {\n        name: fileId.split('/').pop(),\n        mimeType: 'application/octet-stream',\n      };\n    }\n  }\n\n  async createSignedUrl(fileId: string, expiresInSeconds: number = 60) {\n    const command = new GetObjectCommand({\n      Bucket: this.bucket,\n      Key: fileId,\n    });\n\n    try {\n      const signedUrl = await getSignedUrl(this.s3Client, command, {\n        expiresIn: expiresInSeconds,\n      });\n      return { signedUrl };\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to create signed URL: ${error.message}`,\n      );\n    }\n  }\n}\n"],"names":["S3Service","uploadFile","file","timestamp","Date","now","path","originalname","replace","command","PutObjectCommand","Bucket","bucket","Key","Body","buffer","ContentType","mimetype","s3Client","send","id","name","mimeType","webViewLink","error","InternalServerErrorException","message","getFileStream","fileId","GetObjectCommand","response","console","getFileMetadata","HeadObjectCommand","split","pop","createSignedUrl","expiresInSeconds","signedUrl","getSignedUrl","expiresIn","region","process","env","AWS_S3_REGION","accessKeyId","AWS_ACCESS_KEY_ID","secretAccessKey","AWS_SECRET_ACCESS_KEY","bucketName","AWS_S3_BUCKET_NAME","Error","S3Client","credentials"],"mappings":";;;;+BAWaA;;;eAAAA;;;wBAX4C;0BAMlD;oCACsB;;;;;;;;;;AAItB,IAAA,AAAMA,YAAN,MAAMA;IAyBX,MAAMC,WAAWC,IAAyB,EAAE;QAC1C,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,MAAMC,OAAO,CAAC,QAAQ,EAAEH,UAAU,CAAC,EAAED,KAAKK,YAAY,CAACC,OAAO,CAAC,mBAAmB,MAAM;QAExF,MAAMC,UAAU,IAAIC,0BAAgB,CAAC;YACnCC,QAAQ,IAAI,CAACC,MAAM;YACnBC,KAAKP;YACLQ,MAAMZ,KAAKa,MAAM;YACjBC,aAAad,KAAKe,QAAQ;QAC5B;QAEA,IAAI;YACF,MAAM,IAAI,CAACC,QAAQ,CAACC,IAAI,CAACV;YACzB,OAAO;gBACLW,IAAId;gBACJe,MAAMnB,KAAKK,YAAY;gBACvBe,UAAUpB,KAAKe,QAAQ;gBACvBM,aAAa;YACf;QACF,EAAE,OAAOC,OAAO;YACd,MAAM,IAAIC,oCAA4B,CAAC,CAAC,eAAe,EAAED,MAAME,OAAO,EAAE;QAC1E;IACF;IAEA,MAAMC,cAAcC,MAAc,EAAqB;QACrD,MAAMnB,UAAU,IAAIoB,0BAAgB,CAAC;YACnClB,QAAQ,IAAI,CAACC,MAAM;YACnBC,KAAKe;QACP;QAEA,IAAI;YACF,MAAME,WAAW,MAAM,IAAI,CAACZ,QAAQ,CAACC,IAAI,CAACV;YAC1C,OAAOqB,SAAShB,IAAI;QACtB,EAAE,OAAOU,OAAO;YACdO,QAAQP,KAAK,CAAC,sBAAsB;gBAClCI;gBACAJ,OAAOA;YACT;YACA,MAAM,IAAIC,oCAA4B,CAAC,CAAC,iBAAiB,EAAED,MAAME,OAAO,EAAE;QAC5E;IACF;IAEA,MAAMM,gBAAgBJ,MAAc,EAAE;QACpC,MAAMnB,UAAU,IAAIwB,2BAAiB,CAAC;YACpCtB,QAAQ,IAAI,CAACC,MAAM;YACnBC,KAAKe;QACP;QAEA,IAAI;YACF,MAAME,WAAW,MAAM,IAAI,CAACZ,QAAQ,CAACC,IAAI,CAACV;YAC1C,OAAO;gBACLY,MAAMO,OAAOM,KAAK,CAAC,KAAKC,GAAG;gBAC3Bb,UAAUQ,SAASd,WAAW,IAAI;YACpC;QACF,EAAE,OAAOQ,OAAO;YACd,OAAO;gBACLH,MAAMO,OAAOM,KAAK,CAAC,KAAKC,GAAG;gBAC3Bb,UAAU;YACZ;QACF;IACF;IAEA,MAAMc,gBAAgBR,MAAc,EAAES,mBAA2B,EAAE,EAAE;QACnE,MAAM5B,UAAU,IAAIoB,0BAAgB,CAAC;YACnClB,QAAQ,IAAI,CAACC,MAAM;YACnBC,KAAKe;QACP;QAEA,IAAI;YACF,MAAMU,YAAY,MAAMC,IAAAA,gCAAY,EAAC,IAAI,CAACrB,QAAQ,EAAET,SAAS;gBAC3D+B,WAAWH;YACb;YACA,OAAO;gBAAEC;YAAU;QACrB,EAAE,OAAOd,OAAO;YACd,MAAM,IAAIC,oCAA4B,CACpC,CAAC,6BAA6B,EAAED,MAAME,OAAO,EAAE;QAEnD;IACF;IAnGA,aAAc;QACZ,MAAMe,SAASC,QAAQC,GAAG,CAACC,aAAa;QACxC,MAAMC,cAAcH,QAAQC,GAAG,CAACG,iBAAiB;QACjD,MAAMC,kBAAkBL,QAAQC,GAAG,CAACK,qBAAqB;QACzD,MAAMC,aAAaP,QAAQC,GAAG,CAACO,kBAAkB;QAEjD,IAAI,CAACT,UAAU,CAACI,eAAe,CAACE,mBAAmB,CAACE,YAAY;YAC9D,MAAM,IAAIE,MAAM;QAClB;QAEA,IAAI,CAACvC,MAAM,GAAGqC;QAEd,IAAI,CAAC/B,QAAQ,GAAG,IAAIkC,kBAAQ,CAAC;YAC3BX;YACAY,aAAa;gBACXR;gBACAE;YACF;QACF;IACF;AAiFF"}