{"version":3,"sources":["../../src/content/content.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  UseInterceptors,\n  UploadedFile,\n  Get,\n  Req,\n  Res,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { SupabaseService } from './supabase.service';\nimport type { Response } from 'express';\n// import { JwtAuthGuard } from '../auth/jwt-auth.guard'; // Uncomment when ready\n\n@Controller('content')\nexport class ContentController {\n  constructor(private readonly supabaseService: SupabaseService) {}\n\n  @Post('upload')\n  @UseInterceptors(FileInterceptor('file'))\n  async uploadFile(@UploadedFile() file: Express.Multer.File) {\n    return this.supabaseService.uploadFile(file);\n  }\n\n  @Get('stream/*')\n  async streamFile(@Req() req: any, @Res() res: Response) {\n    // Extract the file path from the URL after 'stream/'\n    const fullPath = req.url; // e.g., '/content/stream/uploads/timestamp-filename.pdf'\n    const fileId = fullPath.replace('/content/stream/', '');\n    const decodedFileId = decodeURIComponent(fileId);\n\n    console.log('Streaming file:', decodedFileId);\n\n    try {\n      // Get file metadata to set proper content type\n      const metadata =\n        await this.supabaseService.getFileMetadata(decodedFileId);\n\n      // Get file stream from Supabase\n      const stream = await this.supabaseService.getFileStream(decodedFileId);\n\n      // Set headers for proper PDF/video display\n      res.setHeader(\n        'Content-Type',\n        metadata.mimeType || 'application/octet-stream',\n      );\n      res.setHeader('Accept-Ranges', 'bytes');\n      res.setHeader('Cache-Control', 'no-cache');\n\n      // Stream the file\n      stream.pipe(res);\n    } catch (error) {\n      console.error('Streaming error:', error);\n      res.status(500).send('Failed to stream file');\n    }\n  }\n}\n"],"names":["ContentController","uploadFile","file","supabaseService","streamFile","req","res","fullPath","url","fileId","replace","decodedFileId","decodeURIComponent","console","log","metadata","getFileMetadata","stream","getFileStream","setHeader","mimeType","pipe","error","status","send"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBAPN;iCACyB;iCACA;;;;;;;;;;;;;;;AAKzB,IAAA,AAAMA,oBAAN,MAAMA;IAGX,MAEMC,WAAW,AAAgBC,IAAyB,EAAE;QAC1D,OAAO,IAAI,CAACC,eAAe,CAACF,UAAU,CAACC;IACzC;IAEA,MACME,WAAW,AAAOC,GAAQ,EAAE,AAAOC,GAAa,EAAE;QACtD,qDAAqD;QACrD,MAAMC,WAAWF,IAAIG,GAAG,EAAE,yDAAyD;QACnF,MAAMC,SAASF,SAASG,OAAO,CAAC,oBAAoB;QACpD,MAAMC,gBAAgBC,mBAAmBH;QAEzCI,QAAQC,GAAG,CAAC,mBAAmBH;QAE/B,IAAI;YACF,+CAA+C;YAC/C,MAAMI,WACJ,MAAM,IAAI,CAACZ,eAAe,CAACa,eAAe,CAACL;YAE7C,gCAAgC;YAChC,MAAMM,SAAS,MAAM,IAAI,CAACd,eAAe,CAACe,aAAa,CAACP;YAExD,2CAA2C;YAC3CL,IAAIa,SAAS,CACX,gBACAJ,SAASK,QAAQ,IAAI;YAEvBd,IAAIa,SAAS,CAAC,iBAAiB;YAC/Bb,IAAIa,SAAS,CAAC,iBAAiB;YAE/B,kBAAkB;YAClBF,OAAOI,IAAI,CAACf;QACd,EAAE,OAAOgB,OAAO;YACdT,QAAQS,KAAK,CAAC,oBAAoBA;YAClChB,IAAIiB,MAAM,CAAC,KAAKC,IAAI,CAAC;QACvB;IACF;IAvCA,YAAY,AAAiBrB,eAAgC,CAAE;aAAlCA,kBAAAA;IAAmC;AAwClE;;;;;;;yDApCiD,yCAAA,OAAO,wCAAP,OAAO"}