{"version":3,"sources":["../../src/content/content.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  UseInterceptors,\n  UploadedFile,\n  Get,\n  Param,\n  Res,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { S3Service } from './s3.service';\nimport type { Response } from 'express';\n\n@Controller('content')\nexport class ContentController {\n  constructor(private readonly s3Service: S3Service) {}\n\n  @Post('upload')\n  @UseInterceptors(FileInterceptor('file'))\n  async uploadFile(@UploadedFile() file: Express.Multer.File) {\n    const result = await this.s3Service.uploadFile(file);\n    return {\n      ...result,\n      url: `/content/stream/${result.id}`,\n    };\n  }\n\n  @Get('stream/*path')\n  async streamFile(\n    @Param('path') path: string | string[],\n    @Res() res: Response,\n  ) {\n    // path is the captured string or array from the wildcard route\n    const segments = Array.isArray(path) ? path : [path];\n    const fileId = segments.join('/');\n    const decodedFileId = decodeURIComponent(fileId);\n\n    console.log('Streaming file:', decodedFileId);\n\n    try {\n      // Get file metadata to set proper content type\n      const metadata = await this.s3Service.getFileMetadata(decodedFileId);\n\n      // Get file stream from S3\n      const stream = await this.s3Service.getFileStream(decodedFileId);\n\n      // Set headers for proper PDF/video display\n      res.setHeader(\n        'Content-Type',\n        metadata.mimeType || 'application/octet-stream',\n      );\n      res.setHeader('Accept-Ranges', 'bytes');\n      res.setHeader('Cache-Control', 'no-cache');\n\n      // Stream the file\n      stream.pipe(res);\n    } catch (error) {\n      console.error('Streaming error:', error);\n      res.status(500).send('Failed to stream file');\n    }\n  }\n}\n"],"names":["ContentController","uploadFile","file","result","s3Service","url","id","streamFile","path","res","segments","Array","isArray","fileId","join","decodedFileId","decodeURIComponent","console","log","metadata","getFileMetadata","stream","getFileStream","setHeader","mimeType","pipe","error","status","send"],"mappings":";;;;+BAcaA;;;eAAAA;;;wBANN;iCACyB;2BACN;;;;;;;;;;;;;;;AAInB,IAAA,AAAMA,oBAAN,MAAMA;IAGX,MAEMC,WAAW,AAAgBC,IAAyB,EAAE;QAC1D,MAAMC,SAAS,MAAM,IAAI,CAACC,SAAS,CAACH,UAAU,CAACC;QAC/C,OAAO;YACL,GAAGC,MAAM;YACTE,KAAK,CAAC,gBAAgB,EAAEF,OAAOG,EAAE,EAAE;QACrC;IACF;IAEA,MACMC,WACJ,AAAeC,IAAuB,EACtC,AAAOC,GAAa,EACpB;QACA,+DAA+D;QAC/D,MAAMC,WAAWC,MAAMC,OAAO,CAACJ,QAAQA,OAAO;YAACA;SAAK;QACpD,MAAMK,SAASH,SAASI,IAAI,CAAC;QAC7B,MAAMC,gBAAgBC,mBAAmBH;QAEzCI,QAAQC,GAAG,CAAC,mBAAmBH;QAE/B,IAAI;YACF,+CAA+C;YAC/C,MAAMI,WAAW,MAAM,IAAI,CAACf,SAAS,CAACgB,eAAe,CAACL;YAEtD,0BAA0B;YAC1B,MAAMM,SAAS,MAAM,IAAI,CAACjB,SAAS,CAACkB,aAAa,CAACP;YAElD,2CAA2C;YAC3CN,IAAIc,SAAS,CACX,gBACAJ,SAASK,QAAQ,IAAI;YAEvBf,IAAIc,SAAS,CAAC,iBAAiB;YAC/Bd,IAAIc,SAAS,CAAC,iBAAiB;YAE/B,kBAAkB;YAClBF,OAAOI,IAAI,CAAChB;QACd,EAAE,OAAOiB,OAAO;YACdT,QAAQS,KAAK,CAAC,oBAAoBA;YAClCjB,IAAIkB,MAAM,CAAC,KAAKC,IAAI,CAAC;QACvB;IACF;IA7CA,YAAY,AAAiBxB,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AA8CtD;;;;;;;yDA1CiD,yCAAA,OAAO,wCAAP,OAAO"}