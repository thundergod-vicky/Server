{"version":3,"sources":["../../src/content/content.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  UseInterceptors,\n  UploadedFile,\n  Get,\n  Req,\n  Res,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { S3Service } from './s3.service';\nimport type { Response } from 'express';\n\ninterface UploadResult {\n  id: string;\n  name: string;\n  mimeType: string;\n  webViewLink: string | null;\n}\n\n@Controller('content')\nexport class ContentController {\n  constructor(private readonly s3Service: S3Service) {}\n\n  @Post('upload')\n  @UseInterceptors(FileInterceptor('file'))\n  async uploadFile(@UploadedFile() file: Express.Multer.File) {\n    const result = await this.s3Service.uploadFile(file);\n    return {\n      ...result,\n      url: `/content/stream/${result.id}`,\n    };\n  }\n\n  @Get('stream/*')\n  async streamFile(@Req() req: any, @Res() res: Response) {\n    // Extract the file path from the URL after 'stream/'\n    const fullPath = req.url; // e.g., '/content/stream/uploads/timestamp-filename.pdf'\n    const fileId = fullPath.replace('/content/stream/', '');\n    const decodedFileId = decodeURIComponent(fileId);\n\n    console.log('Streaming file:', decodedFileId);\n\n    try {\n      // Get file metadata to set proper content type\n      const metadata = await this.s3Service.getFileMetadata(decodedFileId);\n\n      // Get file stream from S3\n      const stream = await this.s3Service.getFileStream(decodedFileId);\n\n      // Set headers for proper PDF/video display\n      res.setHeader(\n        'Content-Type',\n        metadata.mimeType || 'application/octet-stream',\n      );\n      res.setHeader('Accept-Ranges', 'bytes');\n      res.setHeader('Cache-Control', 'no-cache');\n\n      // Stream the file\n      stream.pipe(res);\n    } catch (error) {\n      console.error('Streaming error:', error);\n      res.status(500).send('Failed to stream file');\n    }\n  }\n}\n"],"names":["ContentController","uploadFile","file","result","s3Service","url","id","streamFile","req","res","fullPath","fileId","replace","decodedFileId","decodeURIComponent","console","log","metadata","getFileMetadata","stream","getFileStream","setHeader","mimeType","pipe","error","status","send"],"mappings":";;;;+BAqBaA;;;eAAAA;;;wBAbN;iCACyB;2BACN;;;;;;;;;;;;;;;AAWnB,IAAA,AAAMA,oBAAN,MAAMA;IAGX,MAEMC,WAAW,AAAgBC,IAAyB,EAAE;QAC1D,MAAMC,SAAS,MAAM,IAAI,CAACC,SAAS,CAACH,UAAU,CAACC;QAC/C,OAAO;YACL,GAAGC,MAAM;YACTE,KAAK,CAAC,gBAAgB,EAAEF,OAAOG,EAAE,EAAE;QACrC;IACF;IAEA,MACMC,WAAW,AAAOC,GAAQ,EAAE,AAAOC,GAAa,EAAE;QACtD,qDAAqD;QACrD,MAAMC,WAAWF,IAAIH,GAAG,EAAE,yDAAyD;QACnF,MAAMM,SAASD,SAASE,OAAO,CAAC,oBAAoB;QACpD,MAAMC,gBAAgBC,mBAAmBH;QAEzCI,QAAQC,GAAG,CAAC,mBAAmBH;QAE/B,IAAI;YACF,+CAA+C;YAC/C,MAAMI,WAAW,MAAM,IAAI,CAACb,SAAS,CAACc,eAAe,CAACL;YAEtD,0BAA0B;YAC1B,MAAMM,SAAS,MAAM,IAAI,CAACf,SAAS,CAACgB,aAAa,CAACP;YAElD,2CAA2C;YAC3CJ,IAAIY,SAAS,CACX,gBACAJ,SAASK,QAAQ,IAAI;YAEvBb,IAAIY,SAAS,CAAC,iBAAiB;YAC/BZ,IAAIY,SAAS,CAAC,iBAAiB;YAE/B,kBAAkB;YAClBF,OAAOI,IAAI,CAACd;QACd,EAAE,OAAOe,OAAO;YACdT,QAAQS,KAAK,CAAC,oBAAoBA;YAClCf,IAAIgB,MAAM,CAAC,KAAKC,IAAI,CAAC;QACvB;IACF;IA1CA,YAAY,AAAiBtB,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AA2CtD;;;;;;;yDAvCiD,yCAAA,OAAO,wCAAP,OAAO"}