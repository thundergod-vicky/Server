{"version":3,"sources":["../../src/content/supabase.service.ts"],"sourcesContent":["import { Injectable, InternalServerErrorException } from '@nestjs/common';\nimport { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport { Readable } from 'stream';\n\n@Injectable()\nexport class SupabaseService {\n  private supabase: SupabaseClient;\n  private bucket = 'course-content';\n\n  constructor() {\n    const supabaseUrl = process.env.SUPABASE_URL;\n    const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n    if (!supabaseUrl || !supabaseKey) {\n      throw new Error('Supabase credentials missing');\n    }\n\n    this.supabase = createClient(supabaseUrl, supabaseKey);\n  }\n\n  async uploadFile(file: Express.Multer.File) {\n    const timestamp = Date.now();\n    const path = `uploads/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\n\n    const { data, error } = await this.supabase.storage\n      .from(this.bucket)\n      .upload(path, file.buffer, {\n        contentType: file.mimetype,\n        upsert: false,\n      });\n\n    if (error) {\n      // Check if bucket exists, if not try to create (Service role can)\n      if (error.message.includes('Bucket not found')) {\n        await this.createBucket();\n        // Retry\n        return this.uploadFile(file);\n      }\n      throw new InternalServerErrorException(`Upload failed: ${error.message}`);\n    }\n\n    return {\n      id: data.path, // We use the path as the ID\n      name: file.originalname,\n      mimeType: file.mimetype,\n      webViewLink: null,\n    };\n  }\n\n  async getFileStream(fileId: string): Promise<Readable> {\n    const { data, error } = await this.supabase.storage\n      .from(this.bucket)\n      .download(fileId);\n\n    if (error) {\n      console.error('Supabase download error:', {\n        fileId,\n        error: error,\n        message: error.message,\n        statusCode: error.statusCode,\n      });\n      throw new InternalServerErrorException(\n        `Download failed: ${error.message || JSON.stringify(error)}`,\n      );\n    }\n\n    // Convert Blob/ArrayBuffer to Readable Stream\n    const buffer = Buffer.from(await data.arrayBuffer());\n    const stream = new Readable();\n    stream.push(buffer);\n    stream.push(null);\n    return stream;\n  }\n\n  async getFileMetadata(fileId: string) {\n    // fileId is 'uploads/timestamp-name.ext'\n    // We can get public URL or just parse path\n    // To get mimeType, we can list the folder\n    const folder = fileId.split('/').slice(0, -1).join('/');\n    const fileName = fileId.split('/').pop();\n\n    const { data, error } = await this.supabase.storage\n      .from(this.bucket)\n      .list(folder, {\n        search: fileName,\n        limit: 1,\n      });\n\n    if (error || !data || data.length === 0) {\n      return {\n        name: fileName,\n        mimeType: 'application/octet-stream',\n      };\n    }\n\n    return {\n      name: data[0].name,\n      mimeType: data[0].metadata?.mimetype || 'application/octet-stream',\n    };\n  }\n\n  async createSignedUrl(fileId: string, expiresInSeconds: number = 60) {\n    const { data, error } = await this.supabase.storage\n      .from(this.bucket)\n      .createSignedUrl(fileId, expiresInSeconds);\n\n    if (error) {\n      throw new InternalServerErrorException(\n        `Failed to create signed URL: ${error.message}`,\n      );\n    }\n\n    return { signedUrl: data.signedUrl };\n  }\n\n  private async createBucket() {\n    const { data, error } = await this.supabase.storage.createBucket(\n      this.bucket,\n      {\n        public: false, // Private bucket\n      },\n    );\n    if (error) {\n      console.error('Failed to create bucket:', error);\n    }\n  }\n}\n"],"names":["SupabaseService","uploadFile","file","timestamp","Date","now","path","originalname","replace","data","error","supabase","storage","from","bucket","upload","buffer","contentType","mimetype","upsert","message","includes","createBucket","InternalServerErrorException","id","name","mimeType","webViewLink","getFileStream","fileId","download","console","statusCode","JSON","stringify","Buffer","arrayBuffer","stream","Readable","push","getFileMetadata","folder","split","slice","join","fileName","pop","list","search","limit","length","metadata","createSignedUrl","expiresInSeconds","signedUrl","public","supabaseUrl","process","env","SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","Error","createClient"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBAL4C;4BACZ;wBACpB;;;;;;;;;;AAGlB,IAAA,AAAMA,kBAAN,MAAMA;IAeX,MAAMC,WAAWC,IAAyB,EAAE;QAC1C,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,MAAMC,OAAO,CAAC,QAAQ,EAAEH,UAAU,CAAC,EAAED,KAAKK,YAAY,CAACC,OAAO,CAAC,mBAAmB,MAAM;QAExF,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAChDC,IAAI,CAAC,IAAI,CAACC,MAAM,EAChBC,MAAM,CAACT,MAAMJ,KAAKc,MAAM,EAAE;YACzBC,aAAaf,KAAKgB,QAAQ;YAC1BC,QAAQ;QACV;QAEF,IAAIT,OAAO;YACT,kEAAkE;YAClE,IAAIA,MAAMU,OAAO,CAACC,QAAQ,CAAC,qBAAqB;gBAC9C,MAAM,IAAI,CAACC,YAAY;gBACvB,QAAQ;gBACR,OAAO,IAAI,CAACrB,UAAU,CAACC;YACzB;YACA,MAAM,IAAIqB,oCAA4B,CAAC,CAAC,eAAe,EAAEb,MAAMU,OAAO,EAAE;QAC1E;QAEA,OAAO;YACLI,IAAIf,KAAKH,IAAI;YACbmB,MAAMvB,KAAKK,YAAY;YACvBmB,UAAUxB,KAAKgB,QAAQ;YACvBS,aAAa;QACf;IACF;IAEA,MAAMC,cAAcC,MAAc,EAAqB;QACrD,MAAM,EAAEpB,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAChDC,IAAI,CAAC,IAAI,CAACC,MAAM,EAChBgB,QAAQ,CAACD;QAEZ,IAAInB,OAAO;YACTqB,QAAQrB,KAAK,CAAC,4BAA4B;gBACxCmB;gBACAnB,OAAOA;gBACPU,SAASV,MAAMU,OAAO;gBACtBY,YAAYtB,MAAMsB,UAAU;YAC9B;YACA,MAAM,IAAIT,oCAA4B,CACpC,CAAC,iBAAiB,EAAEb,MAAMU,OAAO,IAAIa,KAAKC,SAAS,CAACxB,QAAQ;QAEhE;QAEA,8CAA8C;QAC9C,MAAMM,SAASmB,OAAOtB,IAAI,CAAC,MAAMJ,KAAK2B,WAAW;QACjD,MAAMC,SAAS,IAAIC,gBAAQ;QAC3BD,OAAOE,IAAI,CAACvB;QACZqB,OAAOE,IAAI,CAAC;QACZ,OAAOF;IACT;IAEA,MAAMG,gBAAgBX,MAAc,EAAE;QACpC,yCAAyC;QACzC,2CAA2C;QAC3C,0CAA0C;QAC1C,MAAMY,SAASZ,OAAOa,KAAK,CAAC,KAAKC,KAAK,CAAC,GAAG,CAAC,GAAGC,IAAI,CAAC;QACnD,MAAMC,WAAWhB,OAAOa,KAAK,CAAC,KAAKI,GAAG;QAEtC,MAAM,EAAErC,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAChDC,IAAI,CAAC,IAAI,CAACC,MAAM,EAChBiC,IAAI,CAACN,QAAQ;YACZO,QAAQH;YACRI,OAAO;QACT;QAEF,IAAIvC,SAAS,CAACD,QAAQA,KAAKyC,MAAM,KAAK,GAAG;YACvC,OAAO;gBACLzB,MAAMoB;gBACNnB,UAAU;YACZ;QACF;QAEA,OAAO;YACLD,MAAMhB,IAAI,CAAC,EAAE,CAACgB,IAAI;YAClBC,UAAUjB,IAAI,CAAC,EAAE,CAAC0C,QAAQ,EAAEjC,YAAY;QAC1C;IACF;IAEA,MAAMkC,gBAAgBvB,MAAc,EAAEwB,mBAA2B,EAAE,EAAE;QACnE,MAAM,EAAE5C,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAChDC,IAAI,CAAC,IAAI,CAACC,MAAM,EAChBsC,eAAe,CAACvB,QAAQwB;QAE3B,IAAI3C,OAAO;YACT,MAAM,IAAIa,oCAA4B,CACpC,CAAC,6BAA6B,EAAEb,MAAMU,OAAO,EAAE;QAEnD;QAEA,OAAO;YAAEkC,WAAW7C,KAAK6C,SAAS;QAAC;IACrC;IAEA,MAAchC,eAAe;QAC3B,MAAM,EAAEb,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAACU,YAAY,CAC9D,IAAI,CAACR,MAAM,EACX;YACEyC,QAAQ;QACV;QAEF,IAAI7C,OAAO;YACTqB,QAAQrB,KAAK,CAAC,4BAA4BA;QAC5C;IACF;IApHA,aAAc;aAFNI,SAAS;QAGf,MAAM0C,cAAcC,QAAQC,GAAG,CAACC,YAAY;QAC5C,MAAMC,cAAcH,QAAQC,GAAG,CAACG,yBAAyB;QAEzD,IAAI,CAACL,eAAe,CAACI,aAAa;YAChC,MAAM,IAAIE,MAAM;QAClB;QAEA,IAAI,CAACnD,QAAQ,GAAGoD,IAAAA,wBAAY,EAACP,aAAaI;IAC5C;AA4GF"}