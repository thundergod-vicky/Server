{"version":3,"sources":["../../src/courses/courses.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { Prisma } from '@prisma/client';\n\n@Injectable()\nexport class CoursesService {\n  constructor(private prisma: PrismaService) {}\n\n  async create(data: Prisma.CourseCreateInput) {\n    return this.prisma.course.create({ data });\n  }\n\n  async findAll() {\n    return this.prisma.course.findMany({\n      where: { courseType: 'PUBLIC' },\n      include: { teacher: true, chapters: { include: { lessons: true } } },\n    });\n  }\n\n  async findAllByTeacher(teacherId: string) {\n    return this.prisma.course.findMany({\n      where: { teacherId },\n      include: {\n        _count: {\n          select: { chapters: true, enrollments: true },\n        },\n        chapters: {\n          include: {\n            lessons: true,\n          },\n        },\n      },\n    });\n  }\n\n  async findOne(id: string) {\n    return this.prisma.course.findUnique({\n      where: { id },\n      include: {\n        teacher: true,\n        chapters: {\n          include: {\n            lessons: {\n              orderBy: { order: 'asc' },\n            },\n          },\n          orderBy: { order: 'asc' },\n        },\n      },\n    });\n  }\n\n  async createChapter(data: Prisma.ChapterCreateInput) {\n    // Logic to auto-increment order if not provided\n    return this.prisma.chapter.create({ data });\n  }\n\n  async createLesson(data: Prisma.LessonCreateInput) {\n    return this.prisma.lesson.create({ data });\n  }\n\n  // Premium Course Assignment Methods\n  async getCoursesForStudent(studentId: string) {\n    const publicCourses = await this.prisma.course.findMany({\n      where: { courseType: 'PUBLIC' },\n      include: {\n        teacher: { select: { id: true, name: true, email: true } },\n        _count: { select: { chapters: true, enrollments: true } },\n      },\n    });\n\n    const assignedCourses = await this.prisma.courseAssignment.findMany({\n      where: { studentId },\n      include: {\n        course: {\n          include: {\n            teacher: { select: { id: true, name: true, email: true } },\n            _count: { select: { chapters: true, enrollments: true } },\n          },\n        },\n        teacher: { select: { name: true } },\n      },\n    });\n\n    return {\n      publicCourses,\n      assignedCourses: assignedCourses.map((a) => ({\n        ...a.course,\n        deadline: a.deadline,\n        assignedAt: a.assignedAt,\n        assignedBy: a.teacher,\n      })),\n    };\n  }\n\n  async assignStudentsToCourse(\n    courseId: string,\n    teacherId: string,\n    studentIds: string[],\n    deadline?: Date,\n  ) {\n    // Verify course is PREMIUM and belongs to teacher\n    const course = await this.prisma.course.findFirst({\n      where: { id: courseId, teacherId, courseType: 'PREMIUM' },\n    });\n\n    if (!course) {\n      throw new Error('Course not found or not premium');\n    }\n\n    // Create assignments\n    return await this.prisma.courseAssignment.createMany({\n      data: studentIds.map((studentId) => ({\n        courseId,\n        studentId,\n        assignedBy: teacherId,\n        deadline,\n      })),\n      skipDuplicates: true,\n    });\n  }\n\n  async removeAssignment(\n    courseId: string,\n    studentId: string,\n    teacherId: string,\n  ) {\n    return await this.prisma.courseAssignment.deleteMany({\n      where: {\n        courseId,\n        studentId,\n        assignedBy: teacherId,\n      },\n    });\n  }\n\n  async getAssignedStudents(courseId: string, teacherId: string) {\n    return await this.prisma.courseAssignment.findMany({\n      where: { courseId, assignedBy: teacherId },\n      include: {\n        student: { select: { id: true, name: true, email: true } },\n      },\n      orderBy: { assignedAt: 'desc' },\n    });\n  }\n}\n"],"names":["CoursesService","create","data","prisma","course","findAll","findMany","where","courseType","include","teacher","chapters","lessons","findAllByTeacher","teacherId","_count","select","enrollments","findOne","id","findUnique","orderBy","order","createChapter","chapter","createLesson","lesson","getCoursesForStudent","studentId","publicCourses","name","email","assignedCourses","courseAssignment","map","a","deadline","assignedAt","assignedBy","assignStudentsToCourse","courseId","studentIds","findFirst","Error","createMany","skipDuplicates","removeAssignment","deleteMany","getAssignedStudents","student"],"mappings":"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"}