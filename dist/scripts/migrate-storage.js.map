{"version":3,"sources":["../../src/scripts/migrate-storage.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\nimport * as dotenv from 'dotenv';\nimport * as path from 'path';\n\n// Load environment variables from .env file\ndotenv.config({ path: path.resolve(__dirname, '../../.env') });\n\nconst supabaseUrl = process.env.SUPABASE_URL;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\nconst supabaseBucket = 'course-content';\n\nconst awsRegion = process.env.AWS_S3_REGION;\nconst awsAccessKeyId = process.env.AWS_ACCESS_KEY_ID;\nconst awsSecretAccessKey = process.env.AWS_SECRET_ACCESS_KEY;\nconst awsBucketName = process.env.AWS_S3_BUCKET_NAME;\n\nif (!supabaseUrl || !supabaseKey || !awsRegion || !awsAccessKeyId || !awsSecretAccessKey || !awsBucketName) {\n  console.error('Missing required environment variables. Please check your .env file.');\n  process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey);\nconst s3Client = new S3Client({\n  region: awsRegion,\n  credentials: {\n    accessKeyId: awsAccessKeyId,\n    secretAccessKey: awsSecretAccessKey,\n  },\n});\n\nasync function migrate() {\n  console.log('--- Starting Storage Migration (Supabase -> S3) ---');\n  \n  // List files in Supabase bucket\n  // Note: listing files in Supabase can be tricky if they are deep. \n  // We'll try to list recursively if possible, or iterate through folders.\n  // For simplicity, we'll start with 'uploads/' folder which is common.\n  \n  const folders = ['', 'uploads/']; // Add more if needed\n  \n  for (const folder of folders) {\n    console.log(`Listing files in folder: ${folder || 'root'}...`);\n    \n    const { data: files, error } = await supabase.storage\n      .from(supabaseBucket)\n      .list(folder, { limit: 1000 });\n\n    if (error) {\n      console.error(`Error listing files in ${folder}:`, error.message);\n      continue;\n    }\n\n    if (!files || files.length === 0) {\n      console.log(`No files found in ${folder}.`);\n      continue;\n    }\n\n    console.log(`Found ${files.length} items in ${folder}.`);\n\n    for (const file of files) {\n      // Skip folders\n      if (!file.id) {\n        // If file has no ID, it might be a folder in Supabase list\n        // Note: Supabase list returns objects with metadata if it's a file\n        if (!file.metadata) {\n            console.log(`Skipping potential folder or empty item: ${file.name}`);\n            continue;\n        }\n      }\n\n      const filePath = folder ? `${folder}${file.name}` : file.name;\n      \n      console.log(`Migrating: ${filePath}...`);\n\n      try {\n        // 1. Download from Supabase\n        const { data: blob, error: downloadError } = await supabase.storage\n          .from(supabaseBucket)\n          .download(filePath);\n\n        if (downloadError) {\n          console.error(`  [FAILED] Download error for ${filePath}:`, downloadError.message);\n          continue;\n        }\n\n        // 2. Convert Blob to Buffer for S3\n        const arrayBuffer = await blob.arrayBuffer();\n        const buffer = Buffer.from(arrayBuffer);\n\n        // 3. Upload to S3\n        const uploadCommand = new PutObjectCommand({\n          Bucket: awsBucketName,\n          Key: filePath,\n          Body: buffer,\n          ContentType: blob.type || 'application/octet-stream',\n        });\n\n        await s3Client.send(uploadCommand);\n        console.log(`  [SUCCESS] Migrated ${filePath} to S3.`);\n      } catch (err) {\n        console.error(`  [ERROR] Failed to migrate ${filePath}:`, err.message);\n      }\n    }\n  }\n\n  console.log('--- Migration Complete ---');\n}\n\nmigrate().catch(err => {\n  console.error('Fatal migration error:', err);\n  process.exit(1);\n});\n"],"names":["dotenv","config","path","resolve","__dirname","supabaseUrl","process","env","SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","supabaseBucket","awsRegion","AWS_S3_REGION","awsAccessKeyId","AWS_ACCESS_KEY_ID","awsSecretAccessKey","AWS_SECRET_ACCESS_KEY","awsBucketName","AWS_S3_BUCKET_NAME","console","error","exit","supabase","createClient","s3Client","S3Client","region","credentials","accessKeyId","secretAccessKey","migrate","log","folders","folder","data","files","storage","from","list","limit","message","length","file","id","metadata","name","filePath","blob","downloadError","download","arrayBuffer","buffer","Buffer","uploadCommand","PutObjectCommand","Bucket","Key","Body","ContentType","type","send","err","catch"],"mappings":"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"}